<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¤šå ´ç«™è¨­å‚™ç‹€æ…‹æŸ¥è©¢</title>
  <style>
    table {
      border-collapse: collapse;
      margin: 20px 0;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    h2 {
      margin-top: 30px;
    }
    .status-normal {
      color: green;
      font-weight: bold;
    }
    .status-abnormal {
      color: red;
      font-weight: bold;
    }
    #progress {
      margin: 20px 0;
    }
    #countdown {
      font-size: 16px;
      color: blue;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>
    å¤šå ´ç«™è¨­å‚™ç‹€æ…‹æŸ¥è©¢çµæœ
    <span id="countdown">æ›´æ–°å€’æ•¸ï¼š5 ç§’</span>
  </h1>

  <!-- é€²åº¦æ¢ -->
  <div id="progress">
    <progress id="progressBar" value="0" max="100" style="width:100%;"></progress>
    <p id="progressText">ç­‰å¾…æŸ¥è©¢ä¸­...</p>
  </div>

  <!-- ç•°å¸¸è¨­å‚™é›†ä¸­æ¸…å–® -->
  <div id="abnormal"></div>
  <!-- å®Œæ•´ç¸½è¡¨ -->
  <div id="all"></div>

  <script>
    const token = "ilbnrfsjr6a0fnq20wyz50dtrqp3jah5zohmw8cxmquyubek4cc2wmsqaj0hi41hy5yru50eo4";

    const lotCodes = [
      "188600343","188600416","188600417","188600418","188600419",
      "188600420","188600421","188600422","188600423","188600424",
      "188600425","188600426","188600427","188600428","188600429",
      "188600431","188600432","188600433","188600434","188600435",
      "188600436","188600437","188600438","188600439","188600440",
      "188600442","188600443","188600444","188600446","188600447",
      "188600448","188600449","188600451","188600452","188600453",
      "188600454","188600455","188600456","188600458","188600460",
      "188600461","188600462","188600463","188600464","188600465",
      "188600466","188600467","188600468","188600469","188600471",
      "188600472","188600473","188600474","188600475","188600476",
      "188600477","188600478","188600479","188600480","188600481",
      "188600483","188600484","188600485","188600486","188600487",
      "188600488","188600489","188600490","188600491","188600492",
      "188600493","188600494","188600495","188600496","188600504",
      "188600505","188600516","188600536","188600539","188600540"
    ];

    const refreshInterval = 60; // æ¯å¹¾ç§’æ›´æ–°ä¸€æ¬¡
    let countdown = refreshInterval;

    async function fetchStatus(lotCode) {
      const payload = { lotCode, deviceTypeId:"", name:"", currentPage:1, pageSize:20 };
      try {
        const res = await fetch("https://gpark.keytop.cn/nkc/device/getDeviceStatus", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "kt-token": token,
            "kt-appId": "16bbf366b49a48fab362b7f163d96c63",
            "kt-lotcodes": lotCode,
            "authCode": "device/getDeviceStatus",
            "client-flag": "PC",
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.resultCode === 200 && data.data?.vos) {
          return data.data.vos.map(device => ({
            å ´ç«™: lotCode,
            åç¨±: device.name,
            é¡å‹: device.type,
            IP: device.ip,
            ç‰ˆæœ¬: device.version,
            ç‹€æ…‹: device.status === "1" 
              ? `<span class="status-normal">æ­£å¸¸</span>` 
              : `<span class="status-abnormal">ç•°å¸¸</span>`,
            æª¢æŸ¥æ™‚é–“: device.checkTime
          }));
        } else {
          return [];
        }
      } catch {
        return [];
      }
    }

    function renderTable(list) {
      if (list.length === 0) return "<p>ç„¡è³‡æ–™</p>";
      const headers = Object.keys(list[0]);
      const rows = list.map(item =>
        `<tr>${headers.map(h => `<td>${item[h]}</td>`).join("")}</tr>`
      ).join("");
      return `
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function updateAll() {
      const abnormalDiv = document.getElementById("abnormal");
      const allDiv = document.getElementById("all");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      let allDevices = [];
      let abnormalDevices = [];

      progressBar.value = 0;
      progressText.textContent = "é–‹å§‹æŸ¥è©¢...";

      for (let i = 0; i < lotCodes.length; i++) {
        const devices = await fetchStatus(lotCodes[i]);
        allDevices = allDevices.concat(devices);
        abnormalDevices = abnormalDevices.concat(devices.filter(d => d.ç‹€æ…‹.includes("ç•°å¸¸")));

        progressBar.value = Math.round(((i + 1) / lotCodes.length) * 100);
        progressText.textContent = `å·²å®Œæˆ ${i + 1}/${lotCodes.length} å ´ç«™æŸ¥è©¢`;
      }

      progressText.textContent = "æŸ¥è©¢å®Œæˆ âœ…";

      abnormalDiv.innerHTML = `
        <h2 style="color:red">âš ï¸ å…¨å ´ç«™ç•°å¸¸è¨­å‚™é›†ä¸­æ¸…å–® (å…± ${abnormalDevices.length} å°)</h2>
        ${renderTable(abnormalDevices)}
      `;

      allDiv.innerHTML = `
        <h2>ğŸ“‹ å…¨å ´ç«™å®Œæ•´è¨­å‚™ç¸½è¡¨ (å…± ${allDevices.length} å°)</h2>
        ${renderTable(allDevices)}
      `;

      // é‡è¨­å€’æ•¸ç§’æ•¸
      countdown = refreshInterval;
    }

    // å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
    setInterval(() => {
      const countdownSpan = document.getElementById("countdown");
      countdown--;
      if (countdown <= 0) {
        updateAll();
      }
      countdownSpan.textContent = `æ›´æ–°å€’æ•¸ï¼š${countdown} ç§’`;
    }, 1000);

    // åˆæ¬¡åŸ·è¡Œ
    updateAll();
  </script>
</body>
</html>
