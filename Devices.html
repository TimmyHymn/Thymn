<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¤šå ´ç«™è¨­å‚™ç‹€æ…‹æŸ¥è©¢</title>
  <style>
    table {
      border-collapse: collapse;
      margin: 20px 0;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    h2 {
      margin-top: 30px;
    }
    .status-normal {
      color: green;
      font-weight: bold;
    }
    .status-abnormal {
      color: red;
      font-weight: bold;
    }
    #progress {
      margin: 20px 0;
    }
    #countdown {
      font-size: 16px;
      color: blue;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>
    å¤šå ´ç«™è¨­å‚™ç‹€æ…‹æŸ¥è©¢çµæœ
    <span id="countdown">æ›´æ–°å€’æ•¸ï¼š60 ç§’</span>
  </h1>

  <!-- é€²åº¦æ¢ -->
  <div id="progress">
    <progress id="progressBar" value="0" max="100" style="width:100%;"></progress>
    <p id="progressText">ç­‰å¾…æŸ¥è©¢ä¸­...</p>
  </div>

  <!-- ç•°å¸¸è¨­å‚™é›†ä¸­æ¸…å–® -->
  <div id="abnormal"></div>
  <!-- å®Œæ•´ç¸½è¡¨ -->
  <div id="all"></div>

  <script>
    const token = "ilbnrfsjr6a0fnq20wyz50dtrqp3jah5zohmw9a92yry4xcyak2rome9mqtjpjbq1724qtbih0";

    const lotCodes = [
      "188600343","188600416","188600417","188600418","188600419",
      "188600420","188600421","188600422","188600423","188600424",
      "188600425","188600426","188600427","188600428","188600429",
      "188600431","188600432","188600433","188600434","188600435",
      "188600436","188600437","188600438","188600439","188600440",
      "188600442","188600443","188600444","188600446","188600447",
      "188600448","188600449","188600451","188600452","188600453",
      "188600454","188600455","188600456","188600458","188600460",
      "188600461","188600462","188600463","188600464","188600465",
      "188600466","188600467","188600468","188600469","188600471",
      "188600472","188600473","188600474","188600475","188600476",
      "188600477","188600478","188600479","188600480","188600481",
      "188600483","188600484","188600485","188600486","188600487",
      "188600488","188600489","188600490","188600491","188600492",
      "188600493","188600494","188600495","188600496","188600504",
      "188600505","188600516","188600536","188600539","188600540"
    ];

    const lotNames = {
      "188600343": "å®¶ç¦æ•¦åŒ—",
      "188600416": "æ–°åº—åŠ æ°£ç«™",
      "188600417": "å®¶ç¦æ–°åº—å®‰åº·",
      "188600418": "å¯¶é›…æ¨‚è¯",
      "188600419": "åœŸåŸé‡‘åŸ",
      "188600420": "åœŸåŸå³°å»·",
      "188600421": "æ±æ­¢æ˜å³°å®¶ç¦",
      "188600422": "æ ¼è‡´å®¶ç¦",
      "188600423": "è¯é½¡å®¶ç¦",
      "188600424": "åŒ—æŠ•å…¬é¤¨å®¶ç¦",
      "188600425": "å¯¶é›…æ¥ æ¢“è—ç”°",
      "188600426": "ç‡¦å¤æµ·ä½ƒ",
      "188600427": "å¯¶é›…å¾·è¯",
      "188600428": "åœŸéŠ€æ•¦å’Œ(èˆªæ¸¯å±€)",
      "188600429": "æ—å£æ–‡åŒ–åŒ—å…¨è¯",
      "188600431": "ç‡¦å¤ç¶“åœ‹",
      "188600432": "æ–°åŸ”ç‡¦å¤",
      "188600433": "è—å£½å¸æ€æº",
      "188600434": "è—å£½å¸æ·é‹è·¯",
      "188600435": "è—å£½å¸é›†è³¢è·¯",
      "188600436": "è—å£½å¸ç«¹åŒ—",
      "188600437": "ç«¹åŒ—ä¸‰æ°‘",
      "188600438": "æ¥Šæ¢…è¾²æœƒ",
      "188600439": "è—å£½å¸é’åŸ”",
      "188600440": "å¯¶é›…å¥åº·2",
      "188600442": "å¯¶é›…ç¾å¦æ–‡å¿ƒå—",
      "188600443": "åšæ„›å¤§æ¨“",
      "188600444": "å®¶ç¦å²¡å±±",
      "188600446": "å°ç£å¤§é“",
      "188600447": "èŠ±è“®æ°‘æ¬Š",
      "188600448": "å°åŒ—å—æµ·",
      "188600449": "å°å—è½‰é‹ç«™-æ±½è»Š",
      "188600451": "è—å£½å¸å“¡æ—",
      "188600452": "å°åŒ—å…§æ¹–",
      "188600453": "å°ä¸­ç¾æ‘å—",
      "188600454": "ç‡¦å¤å…§åŸ”",
      "188600455": "å¯¶å®¶æ½®å·",
      "188600456": "å®¶ç¦è±å—",
      "188600458": "ç‡¦å¤æ°¸è¯",
      "188600460": "å–œäº’æƒ ç¾…èŠ",
      "188600461": "å–œäº’æƒ æ–‡åŒ–",
      "188600462": "å–œäº’æƒ æ…ˆå®‰",
      "188600463": "å¯¶é›…å…§å£¢",
      "188600464": "é›€å®¢èŠ±è“®",
      "188600465": "å¯¶é›…é³³å±±äº”ç¦",
      "188600466": "å˜‰ç¾©æ–°æ°‘2",
      "188600467": "è¿ªå¡å„‚",
      "188600468": "å–œäº’æƒ é ­åŸ",
      "188600469": "å–œäº’æƒ å’Œå¹³",
      "188600471": "è—å£½å¸ä¸­æ¸…",
      "188600472": "è—å£½å¸ç¦ç§‘",
      "188600473": "è—å£½å¸æƒ æ–‡",
      "188600474": "è—å£½å¸æ²™é¹¿",
      "188600475": "è—å£½å¸å˜‰ç¾©",
      "188600476": "è—å£½å¸é ­ä»½",
      "188600477": "è—å£½å¸é–‹å…ƒ",
      "188600478": "è—å£½å¸æ¥ æ¢“è—ç”°",
      "188600479": "æ·¡æ°´æ–°æ°‘",
      "188600480": "æ—å£ä»æ„›äºŒå ´",
      "188600481": "ç‡¦å¤å½°åŒ–",
      "188600483": "åŒ—æ–—ä¸­å±±å ´",
      "188600484": "æ–°åº—åŒ—æ–°å ´",
      "188600485": "è˜†æ´²ä¸­å±±å ´",
      "188600486": "ç‡¦å¤å…‰å¾©å ´",
      "188600487": "ç‡¦å¤ç‘éš†",
      "188600488": "å“¡æ—åœ‹å®…å ´",
      "188600489": "ç‡¦å¤å½°åŒ–å ´",
      "188600490": "æ™¯å¹³å¤©ç©º",
      "188600491": "ç‰›åŸ”æ±",
      "188600492": "ç‡¦å¤å—å´",
      "188600493": "å°ä¸­å¤§é‡Œ",
      "188600494": "å®¶ç¦é¾å®‰",
      "188600495": "å®¶ç¦è‡ªç”±",
      "188600496": "å®¶ç¦é‡å’Œ",
      "188600504": "å¯¶é›…æƒ æ°‘",
      "188600505": "é«˜é›„åšæ„›",
      "188600516": "ç‡¦å¤è±æ¨‚",
      "188600536": "æ°´ä¸Šä¸­èˆˆ",
      "188600539": "æ·¡æ°´ä¸­å±±å ´",
      "188600540": "å°å—éƒ¡å¹³å ´"
    };

    const refreshInterval = 60; // æ¯å¹¾ç§’æ›´æ–°ä¸€æ¬¡
    let countdown = refreshInterval;

    async function fetchStatus(lotCode) {
      const payload = { lotCode, deviceTypeId:"", name:"", currentPage:1, pageSize:20 };
      try {
        const res = await fetch("https://gpark.keytop.cn/nkc/device/getDeviceStatus", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "kt-token": token,
            "kt-appId": "16bbf366b49a48fab362b7f163d96c63",
            "kt-lotcodes": lotCode,
            "authCode": "device/getDeviceStatus",
            "client-flag": "PC",
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.resultCode === 200 && data.data?.vos) {
          return data.data.vos.map(device => ({
            å ´ç«™ä»£ç¢¼: lotCode,
            å ´ç«™åç¨±: lotNames[lotCode] || "æœªçŸ¥å ´ç«™",
            è¨­å‚™åç¨±: device.name,
            è¨­å‚™é¡å‹: device.type,
            IPä½å€: device.ip,
            ç‰ˆæœ¬: device.version,
            ç‹€æ…‹: device.status === "1" 
              ? `<span class="status-normal">æ­£å¸¸</span>` 
              : `<span class="status-abnormal">ç•°å¸¸</span>`,
            æª¢æŸ¥æ™‚é–“: device.checkTime
          }));
        } else {
          return [];
        }
      } catch {
        return [];
      }
    }

    function renderTable(list) {
      if (list.length === 0) return "<p>ç„¡è³‡æ–™</p>";
      
      // å®šç¾©è¡¨æ ¼æ¬„ä½é †åº
      const headers = ["å ´ç«™ä»£ç¢¼", "å ´ç«™åç¨±", "è¨­å‚™åç¨±", "è¨­å‚™é¡å‹", "IPä½å€", "ç‰ˆæœ¬", "ç‹€æ…‹", "æª¢æŸ¥æ™‚é–“"];
      
      const rows = list.map(item =>
        `<tr>${headers.map(h => `<td>${item[h]}</td>`).join("")}</tr>`
      ).join("");
      
      return `
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function updateAll() {
      const abnormalDiv = document.getElementById("abnormal");
      const allDiv = document.getElementById("all");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      let allDevices = [];
      let abnormalDevices = [];

      progressBar.value = 0;
      progressText.textContent = "é–‹å§‹æŸ¥è©¢...";

      for (let i = 0; i < lotCodes.length; i++) {
        const devices = await fetchStatus(lotCodes[i]);
        allDevices = allDevices.concat(devices);
        abnormalDevices = abnormalDevices.concat(devices.filter(d => d.ç‹€æ…‹.includes("ç•°å¸¸")));

        progressBar.value = Math.round(((i + 1) / lotCodes.length) * 100);
        progressText.textContent = `å·²å®Œæˆ ${i + 1}/${lotCodes.length} å ´ç«™æŸ¥è©¢`;
      }

      progressText.textContent = "æŸ¥è©¢å®Œæˆ âœ…";

      abnormalDiv.innerHTML = `
        <h2 style="color:red">âš ï¸ å…¨å ´ç«™ç•°å¸¸è¨­å‚™é›†ä¸­æ¸…å–® (å…± ${abnormalDevices.length} å°)</h2>
        ${renderTable(abnormalDevices)}
      `;

      allDiv.innerHTML = `
        <h2>ğŸ“‹ å…¨å ´ç«™å®Œæ•´è¨­å‚™ç¸½è¡¨ (å…± ${allDevices.length} å°)</h2>
        ${renderTable(allDevices)}
      `;

      // é‡è¨­å€’æ•¸ç§’æ•¸
      countdown = refreshInterval;
    }

    // å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
    setInterval(() => {
      const countdownSpan = document.getElementById("countdown");
      countdown--;
      if (countdown <= 0) {
        updateAll();
      }
      countdownSpan.textContent = `æ›´æ–°å€’æ•¸ï¼š${countdown} ç§’`;
    }, 1000);

    // åˆæ¬¡åŸ·è¡Œ
    updateAll();
  </script>
</body>
</html>

