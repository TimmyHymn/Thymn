<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>網頁版詩歌</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: Verdana, sans-serif;
            height: 100%;
            width: 100%;
            background-color: #f7f7f7;
        }

        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        td {
            padding: 2px;
        }

        input[type="button"] {
            width: 100%;
            height: 100%;
            font-size: 6vw;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        input[type="button"]:hover {
            background-color: #e0e0e0;
        }

        .btn-blue {
            background-color: #0066cc;
            color: #fff;
        }

        .btn-yellow {
            background-color: #ffcc00;
            color: #000;
        }

        .btn-red {
            background-color: #ff3333;
            color: #fff;
        }

        .btn-green {
            background-color: #33cc33;
            color: #fff;
        }

        /* SHOW 區域樣式 */
        #SHOW {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center; /* 置中顯示歌詞 */
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 200px; /* 最小高度確保顯示 */
            display: block; /* 確保顯示區域是可見的 */
        }
 
 
/* 搜尋輸入框樣式 */
#search-container {
    display: none;  /* 預設為不顯示 */
    margin-top: 20px;
    text-align: center;
}

#search-input {
    width: 80%;
    padding: 10px;
font-size: 6vw;

}

#search-button {
    padding: 10px 20px;
    font-size: 6vw;

    margin-left: 10px;
    cursor: pointer;
}
    </style>
</head>
<body>
    <table>
        <tr>
            <td><input type="button" id="book-display" value="" class="btn-blue" disabled></td>
            <td><input type="button" id="book-number" value="" class="btn-blue" disabled></td>
            <td><input type="button" value="⌫" class="D"></td>
        </tr>
        <tr>
            <td><input type="button" value="詩歌" class="btn-blue" onclick="showBookName(1, '詩歌')"></td>
            <td><input type="button" value="1" class="btn-yellow"></td>
            <td><input type="button" value="2" class="btn-yellow"></td>
            <td><input type="button" value="3" class="btn-yellow"></td>
        </tr>
        <tr>
            <td><input type="button" value="補充" class="btn-blue" onclick="showBookName(2, '補充')"></td>
            <td><input type="button" value="4" class="btn-yellow"></td>
            <td><input type="button" value="5" class="btn-yellow"></td>
            <td><input type="button" value="6" class="btn-yellow"></td>
        </tr>
        <tr>
            <td><input type="button" value="新頌" class="btn-blue" onclick="showBookName(3, '新頌')"></td>
            <td><input type="button" value="7" class="btn-yellow"></td>
            <td><input type="button" value="8" class="btn-yellow"></td>
            <td><input type="button" value="9" class="btn-yellow"></td>
        </tr>
        <tr>
            <td><input type="button" value="紅本" class="btn-blue" onclick="showBookName(4, '紅本')"></td>
            <td><input type="button" value="清除" class="btn-red"></td>
            <td><input type="button" value="0" class="btn-yellow"></td>
            <td><input type="button" value="確認" class="btn-green"></td>
        </tr>
        <tr>
            <td><input type="button" value="藍本" class="btn-blue" onclick="showBookName(5, '藍本')"></td>
            <td><input type="button" value="兒童" class="btn-blue" onclick="showBookName(6, '兒童')"></td>
            <td><input type="button" value="搜尋" class="btn-red" onclick="toggleSearch()"></td>
            <td><input type="button" value="說明" class="btn-red"></td>
        </tr>
    </table> 
<div id="search-container">
    <input type="text" id="search-input" placeholder="輸入搜尋關鍵字...">
    <button id="search-button" class="btn-blue" onclick="search()">搜尋</button>
</div>
    
    <div id="SHOW"></div>

    <script>
        // 檢查 localStorage 版本
        const currentVersion = 20241229;
        const storedVersion = localStorage.getItem('hymnsVersion');

        // 如果 localStorage 版本不對或沒有 localStorage，載入 hymns.js
        if (storedVersion !== String(currentVersion)) {
            const script = document.createElement('script');
            script.src = 'hymns.js';
            document.head.appendChild(script);
        }

function showBookName(bookCode, bookName) {
    document.getElementById('book-display').value = bookName;
    document.getElementById('book-number').value = ''; // 清空 book-number 的值
    document.getElementById('SHOW').innerHTML = '';
    document.getElementById('SHOW').style.display = 'none';
}

        function formatLyrics(lyrics) {
            const lines = lyrics.split('\n');
            let longestLine = '';

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > longestLine.length) {
                    longestLine = lines[i];
                }
            }

            const screenWidth = window.innerWidth;
            const charCount = longestLine.length;
            const fontSize = (screenWidth / charCount) * 0.9;

            let formattedLyrics = '';
            for (let i = 0; i < lines.length; i++) {
                if (i === 0) {
                    formattedLyrics += `<div style="font-size: ${fontSize}px; color: red;">${lines[i]}</div>`;
                } else {
                    formattedLyrics += `<div style="font-size: ${fontSize}px;">${lines[i]}</div>`;
                }
            }
            return formattedLyrics;
        }

function searchLyrics(book, code) {
    const hymns = JSON.parse(localStorage.getItem('hymns')) || [];

    const bookCodeMap = {
        '詩歌': 1,
        '補充': 2,
        '新頌': 3,
        '紅本': 4,
        '兒童': 5,
        '藍本': 6
    };
    const hymn = hymns.find(hymn => hymn.book === bookCodeMap[book] && hymn.code === code);

    if (hymn) {
        const formattedLyrics = formatLyrics(hymn.lyrics);
        let result = formattedLyrics;

        // 取得並顯示上次點歌日期
        const favorite = hymn.favorite;
        if (favorite) {
            // 直接顯示 favorite 的值
            result += `<div style="font-size: 6vw; color: blue;">上次點歌日期: ${favorite}</div>`;
        }

        // 顯示格式化後的歌詞
        document.getElementById('SHOW').innerHTML = result;
        document.getElementById('SHOW').style.display = 'block';
        document.getElementById('SHOW').scrollIntoView();

    } else {
        alert('找不到對應的歌詞');
    }
}

        document.addEventListener('DOMContentLoaded', function() {
            let numberValue = "";
            const numberDisplay = document.getElementById('book-number');

    // 防止雙擊縮放
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        let now = new Date().getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
            
            function updateNumberDisplay() {
                numberDisplay.value = numberValue;
            }

            const numberButtons = document.querySelectorAll('.btn-yellow');
            numberButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    numberValue += this.value;
                    updateNumberDisplay();
                });
            });

            const backButton = document.querySelector('.D');
            backButton.addEventListener('click', function() {
                numberValue = numberValue.slice(0, -1);
                updateNumberDisplay();
            });

            const clearButton = document.querySelector('.btn-red');
            clearButton.addEventListener('click', function() {
                document.getElementById('book-display').value = '';
                document.getElementById('book-number').value = '';
                numberValue = '';
                updateNumberDisplay();
                document.getElementById('SHOW').innerHTML = '';
                document.getElementById('SHOW').style.display = 'none';
 
                document.getElementById('search-container').style.display = 'none';    
            });

            const confirmButton = document.querySelector('.btn-green');
confirmButton.addEventListener('click', function() {
    const bookName = document.getElementById('book-display').value;
    const bookNumber = parseInt(document.getElementById('book-number').value, 10);

    if (bookName && bookNumber) {
        searchLyrics(bookName, bookNumber);

        // 取得當天的日期，並轉換為民國年格式
        const today = new Date();
        const gregorianYear = today.getFullYear();  // 公元年
        const taiwanYear = gregorianYear - 1911;  // 民國年
        const month = today.getMonth() + 1;  // 月份 (1-12)
        const day = today.getDate();  // 日期 (1-31)

        // 轉換為民國日期數字，格式：民國年（例如：1131216）
        const taiwanDate = `${taiwanYear}${month.toString().padStart(2, '0')}${day.toString().padStart(2, '0')}`;

        // 取得 hymns 資料並更新 favorite
        const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
        const bookCodeMap = {
            '詩歌': 1,
            '補充': 2,
            '新頌': 3,
            '紅本': 4,
            '兒童': 5,
            '藍本': 6
        };

        // 尋找相對應的歌本和歌號
        const hymn = hymns.find(hymn => hymn.book === bookCodeMap[bookName] && hymn.code === bookNumber);

        if (hymn) {
            // 儲存民國日期到 favorite 屬性
            hymn.favorite = parseInt(taiwanDate, 10);

            // 更新 hymns 並儲存回 localStorage
            localStorage.setItem('hymns', JSON.stringify(hymns));
        } else {
            alert('找不到對應的歌詞');
        }
    } else {
        alert("請選擇歌本名稱並輸入歌本號碼。");
    }
});
        });
 
        
        
function toggleSearch() {
    const searchContainer = document.getElementById('search-container');
    if (searchContainer.style.display === 'none' || searchContainer.style.display === '') {
        searchContainer.style.display = 'block';
 
        document.getElementById('search-container').scrollIntoView();

    } else {
        searchContainer.style.display = 'none';
    }
}

// 合併字型放大與關鍵字高亮的功能
function formatLyrics(lyrics) {
    const lines = lyrics.split('\n');
    let longestLine = '';

    for (let i = 0; i < lines.length; i++) {
        const digitCount = (lines[i].match(/\d/g) || []).length;
        if (lines[i].length > longestLine.length && digitCount <= 3) {
            longestLine = lines[i];
        }
    }

    const screenWidth = window.innerWidth;
    const charCount = longestLine.length;
    const fontSize = (screenWidth / charCount) * 0.93;

    let formattedLyrics = '';
    for (let i = 0; i < lines.length; i++) {
        if (i === 0) {
            formattedLyrics += `<div style="font-size: ${fontSize}px; color: red;">${lines[i]}</div>`;
        } else {
            formattedLyrics += `<div style="font-size: ${fontSize}px;">${lines[i]}</div>`;
        }
    }
    return formattedLyrics;
}











function formatLyricsWithHighlight(lyrics, keyword) {
    const lines = lyrics.split('\n');
    let longestLine = '';

    // 找到最長的一行來動態調整字體大小
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].length > longestLine.length) {
            longestLine = lines[i];
        }
    }

    // 計算字體大小
    const screenWidth = window.innerWidth;
    const charCount = longestLine.length;
    const fontSize = (screenWidth / charCount) * 0.9;

    let formattedLyrics = '';

    // 格式化每一行歌詞並高亮關鍵字
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // 如果有關鍵字，則進行高亮處理
        if (keyword) {
            const regex = new RegExp(keyword, 'gi');
            line = line.replace(regex, match => `<span style="color: red;">${match}</span>`); // 高亮顯示關鍵字
        }

        formattedLyrics += `<div style="font-size: ${fontSize}px;">${line}</div>`;
    }

    return formattedLyrics;
}

// 搜尋功能
function search() {
    const keyword = document.getElementById('search-input').value.trim();
    if (!keyword) {
        alert('請輸入搜尋關鍵字');
        return;
    }

    const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
    const bookCodeMap = {
        1: '詩歌',
        2: '補充',
        3: '新頌',
        4: '紅本',
        5: '兒童',
        6: '藍本'
    };

    const regex = new RegExp(keyword, 'gi'); // 設定搜尋正則表達式
    let results = '';
    let lastCode = null; // 用來追蹤上一個顯示的 code

    hymns.forEach(hymn => {
        let displayTitle = false;
        let displayLyrics = '';

        // 檢查標題是否符合關鍵字
        if (regex.test(hymn.title)) {
            displayTitle = true;
        }

        // 檢查歌詞是否符合關鍵字，並對符合的部分高亮
        let matchingLine = '';
        const lines = hymn.lyrics.split('\n');
        for (let line of lines) {
            if (regex.test(line)) {
                // 只顯示第一個符合的歌詞行
                matchingLine = formatLyricsLine(line, keyword);
                break; // 找到第一個符合的行後就跳出
            }
        }

        // 如果有符合的歌詞行，顯示它
        if (matchingLine) {
            displayLyrics = matchingLine;
        }

        // 顯示符合條件的標題和歌詞
        if (displayTitle || displayLyrics) {
            // 如果 code 變更了，加入一個換行
            if (lastCode && lastCode !== hymn.code) {
                results += '<br/><br/><br/>'; // 加入額外的換行
            }

            // 處理標題，設定顏色為深藍，並對關鍵字反紅
            results += `<div style="font-size: 6vw; color: darkblue;">${bookCodeMap[hymn.book]} ${hymn.code}: ${formatTitleLine(hymn.title, keyword)}</div>`;
            if (displayLyrics) {
                results += `<div style="font-size: 6vw;">${displayLyrics}</div>`;
            }

            // 更新最後一次顯示的 code
            lastCode = hymn.code;
        }
    });

    // 若無符合結果，顯示提示
    if (!results) {
        results = '找不到符合的結果';
    }

    // 將結果顯示到 SHOW 區域
    document.getElementById('SHOW').innerHTML = results;
    document.getElementById('SHOW').style.display = 'block';
    document.getElementById('search-container').style.display = 'none';    
}

// 用來格式化歌詞行並高亮顯示搜尋關鍵字
function formatLyricsLine(line, keyword) {
    const regex = new RegExp(keyword, 'gi');
    return line.replace(regex, match => `<span style="color: red;">${match}</span>`);
}

// 處理標題行，設定顏色為深藍並高亮關鍵字
function formatTitleLine(title, keyword) {
    const regex = new RegExp(keyword, 'gi');
    return title.replace(regex, match => `<span style="color: red;">${match}</span>`);
}

    </script>
</body>
</html>
