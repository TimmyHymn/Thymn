<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>博客停車場導航</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
/* BB */
.progress-container,
.progress-bar,
.progress-text,
#progress-container,
.progress-indicator {
    display: none !important;
    visibility: hidden !important;
}
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        
        .update-info {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        #countdown {
            font-weight: bold;
            color: #fbbf24;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 15px;
            flex-grow: 1;
            gap: 20px;
        }
        
        .section {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .section-header h2 {
            font-size: 1.3rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .status-full {
            background-color: #ef4444;
            color: white;
        }
        
        .status-available {
            background-color: #10b981;
            color: white;
        }
        
        .location-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        #location-info {
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            min-height: 48px;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:active {
            background-color: #2563eb;
            transform: translateY(1px);
        }
        
        .btn-secondary {
            background-color: #10b981;
            color: white;
        }
        
        .btn-secondary:active {
            background-color: #059669;
            transform: translateY(1px);
        }
        
        .btn-disabled {
            background-color: #94a3b8;
            color: #cbd5e1;
            cursor: not-allowed;
        }
        
        .selected-parking {
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #bfdbfe;
            display: none;
            margin-bottom: 20px;
        }
        
        .selected-parking.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .parking-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 16px;
        }
        
        .detail-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .detail-box h4 {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-box p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .parking-list-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            -webkit-overflow-scrolling: touch;
        }
        
        .parking-item {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .parking-item:active {
            background-color: #e2e8f0;
        }
        
        .parking-item.selected {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        
        .parking-info {
            flex-grow: 1;
        }
        
        .parking-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parking-id {
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        
        .parking-distance {
            font-weight: 600;
            color: #10b981;
            font-size: 0.9rem;
        }
        
        .parking-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .spaces-count {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .status-available-cell {
            color: #10b981;
        }
        
        .status-full-cell {
            color: #ef4444;
        }
        
        .status-label {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-label.available {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-label.full {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-label.loading {
            background-color: #e2e8f0;
            color: #475569;
        }
        
        .progress-container {
            background-color: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        #progressBar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        #progressText {
            text-align: center;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .location-permission-help {
            background-color: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        
        .location-permission-help h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .location-permission-help ol {
            padding-left: 20px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #78350f;
        }
        
        .location-permission-help li {
            margin-bottom: 5px;
        }
        
        .address-input-container {
            background-color: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .address-input-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .address-input-container h4 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .address-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .address-input input {
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
        }
        
        .address-input input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .address-examples {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }
        
        .address-examples p {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .address-examples ul {
            padding-left: 20px;
            font-size: 0.85rem;
            color: #475569;
        }
        
        .address-examples li {
            margin-bottom: 5px;
        }
        
        .default-locations {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        .default-locations p {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 10px;
        }
        
        .default-location-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .default-location-btn {
            flex: 1;
            min-width: 140px;
            padding: 10px;
            font-size: 0.9rem;
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .default-location-btn:active {
            background-color: #cbd5e1;
            transform: translateY(1px);
        }
        
        footer {
            text-align: center;
            padding: 20px 15px;
            background-color: #f1f5f9;
            color: #64748b;
            font-size: 0.8rem;
            border-top: 1px solid #e2e8f0;
            margin-top: auto;
        }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 手機橫向優化 */
        @media (min-width: 480px) and (max-width: 768px) {
            .container {
                max-width: 95%;
                margin: 10px auto;
                border-radius: 16px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            header {
                border-radius: 16px 16px 0 0;
            }
        }
        
        /* 平板優化 */
        @media (min-width: 769px) {
            .container {
                max-width: 700px;
                margin: 20px auto;
                border-radius: 20px;
            }
            
            .main-content {
                padding: 25px;
            }
            
            header {
                border-radius: 20px 20px 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-parking"></i>
                <h1>博客停車場導航</h1>
            </div>
            <p class="subtitle">GPS定位 + 實時車位查詢 (60秒自動更新)</p>
            <div class="update-info">
                <span>更新倒數: <span id="countdown">60</span> 秒</span>
                <span id="last-update">尚未更新</span>
            </div>
        </header>
        
        <div class="main-content">
            <!-- 位置區塊 -->
            <section class="section">
                <div class="section-header">
                    <h2><i class="fas fa-map-marker-alt"></i> 您目前的位置</h2>
                </div>
                
                <div class="location-info">
                    <div id="location-info">點擊下方按鈕取得您的位置</div>
                    <button id="get-location-btn" class="btn btn-primary">
                        <i class="fas fa-location-crosshairs"></i>
                        取得目前位置
                    </button>
                    
                    <!-- 地址輸入區塊 -->
                    <div id="address-input-container" class="address-input-container">
                        <h4><i class="fas fa-map-pin"></i> 請輸入您的地址進行定位</h4>
                        <div class="address-input">
                            <input type="text" id="address-input-field" placeholder="例如：新北市新店區安和路三段37號" autocomplete="off">
                            <button id="use-address-btn" class="btn btn-secondary">
                                <i class="fas fa-search-location"></i>
                                使用此地址定位
                            </button>
                        </div>
                        
                        <div class="address-examples">
                            <p><strong>台灣地址輸入技巧：</strong></p>
                            <ul>
                                <li>請包含縣市、區、路名，例如：<strong>新北市新店區安和路三段37號</strong></li>
                                <li>或直接輸入地標，例如：<strong>新店捷運站</strong>、<strong>新店區公所</strong></li>
                                <li>如果找不到詳細地址，可以只輸入路名，例如：<strong>新店區中正路</strong></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- iPhone位置權限說明 -->
                    <div id="location-permission-help" class="location-permission-help">
                        <h4><i class="fas fa-info-circle"></i> iPhone位置權限設定說明：</h4>
                        <ol>
                            <li>點擊Safari網址欄左邊的「大小」圖示（AA）</li>
                            <li>選擇「網站設定」</li>
                            <li>將「位置」設定改為「允許」</li>
                            <li>返回網頁，重新點擊「取得目前位置」</li>
                        </ol>
                        <p style="font-size: 0.85rem; color: #92400e; margin-bottom: 10px;">
                            如果不想使用GPS定位，您也可以使用地址定位功能。
                        </p>
                    </div>
                </div>
                
                <!-- 預設位置區塊 -->
                <div class="default-locations">
                    <p>或直接使用預設位置：</p>
                    <div class="default-location-buttons">
                        <button id="use-taipei-station" class="default-location-btn">
                            <i class="fas fa-train"></i> 台北車站
                        </button>
                        <button id="use-taipei101" class="default-location-btn">
                            <i class="fas fa-building"></i> 台北101
                        </button>
                        <button id="use-kaohsiung" class="default-location-btn">
                            <i class="fas fa-sun"></i> 高雄車站
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- 選中停車場區塊 -->
            <div id="selected-parking" class="selected-parking">
                <div class="section-header">
                    <h3>導航目的地</h3>
                    <div class="distance-badge status-available" id="distance-badge">約 0 公里</div>
                </div>
                
                <div class="parking-details">
                    <div class="detail-box">
                        <h4>停車場名稱</h4>
                        <p id="selected-name">尚未選擇</p>
                    </div>
                    <div class="detail-box">
                        <h4>停車場編號</h4>
                        <p id="selected-id">--</p>
                    </div>
                    <div class="detail-box">
                        <h4>剩餘車位</h4>
                        <p id="selected-spaces">-- / --</p>
                    </div>
                    <div class="detail-box">
                        <h4>車位狀態</h4>
                        <p id="selected-status">--</p>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button id="navigate-btn" class="btn btn-secondary" disabled>
                        <i class="fas fa-directions"></i>
                        使用Google Maps導航
                    </button>
                    <button id="copy-address-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-copy"></i>
                        複製地址
                    </button>
                </div>
            </div>
            
            <!-- 進度顯示區塊 -->
            <div id="progress-container" class="progress-container">
                <progress id="progressBar" value="0" max="100"></progress>
                <p id="progressText">等待查詢中...</p>
            </div>
            
            <!-- 停車場列表區塊 -->
            <section class="section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> 停車場列表 (按距離排序)</h2>
                    <div class="status-badge status-available" id="available-count">可用: --</div>
                </div>
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 12px;">點擊停車場即可設為導航目的地</p>
                <div class="parking-list-container" id="parking-list">
                    <!-- 停車場列表將由JavaScript動態生成 -->
                </div>
            </section>
        </div>
        
        <footer>
            <p>© 2025 CK_Timmy 博客停車場導航系統 | 本系統使用Google Maps進行導航</p>
            <p style="margin-top: 8px; font-size: 0.75rem;">位置資料僅供本頁面使用，每60秒自動更新車位資訊</p>
        </footer>
    </div>

    <script>
        // API配置
        const token = "ilbnrfsjr6a0fnq20wyz50dtrqp3jah5zohmw9a92yry4xcyak2rome9mqtjpjbq1724qtbih0";
        const refreshInterval = 60; // 每幾秒更新一次
        
        // 博客停車場資料
        const parkingLots = {
            "188600343": { name: "家福敦北", lat: 25.052, lng: 121.544 },
            "188600416": { name: "新店加氣站", lat: 24.9819694, lng: 121.5150789 },
            "188600417": { name: "家福新店安康", lat: 24.967, lng: 121.531 },
            "188600418": { name: "寶雅樂華", lat: 25.0089627, lng: 121.5077618 },
            "188600419": { name: "土城金城", lat: 24.986, lng: 121.444 },
            "188600420": { name: "土城峰廷", lat: 24.972, lng: 121.426 },
            "188600421": { name: "汐止明峰家福", lat: 25.068, lng: 121.657 },
            "188600422": { name: "格致家福", lat: 25.139, lng: 121.506 },
            "188600423": { name: "華齡家福", lat: 25.085, lng: 121.520 },
            "188600424": { name: "北投公館家福", lat: 25.117, lng: 121.498 },
            "188600425": { name: "寶雅楠梓藍田", lat: 22.727, lng: 120.326 },
            "188600426": { name: "燦坤海佃", lat: 23.042, lng: 120.185 },
            "188600427": { name: "寶雅德華", lat: 25.039, lng: 121.555 },
            "188600428": { name: "土銀敦和(航港局)", lat: 25.026, lng: 121.548 },
            "188600429": { name: "林口文化北全聯", lat: 25.077, lng: 121.365 },
            "188600431": { name: "燦坤經國", lat: 24.996, lng: 121.299 },
            "188600432": { name: "新埔燦坤", lat: 24.970, lng: 121.408 },
            "188600433": { name: "藏壽司思源", lat: 25.052, lng: 121.463 },
            "188600434": { name: "藏壽司捷運路", lat: 25.017, lng: 121.463 },
            "188600435": { name: "藏壽司集賢路", lat: 25.086, lng: 121.494 },
            "188600436": { name: "藏壽司竹北", lat: 24.829, lng: 121.016 },
            "188600437": { name: "竹北三民", lat: 24.833, lng: 121.012 },
            "188600438": { name: "楊梅農會", lat: 24.914, lng: 121.146 },
            "188600439": { name: "藏壽司青埔", lat: 25.008, lng: 121.201 },
            "188600440": { name: "寶雅健康2", lat: 22.625, lng: 120.318 },
            "188600442": { name: "寶雅美妝文心南", lat: 24.142, lng: 120.647 },
            "188600443": { name: "博愛大樓", lat: 25.044, lng: 121.520 },
            "188600444": { name: "家福岡山", lat: 22.796, lng: 120.295 },
            "188600446": { name: "台灣大道", lat: 24.164, lng: 120.672 },
            "188600447": { name: "花蓮民權", lat: 23.976, lng: 121.606 },
            "188600448": { name: "台北南海", lat: 25.032, lng: 121.514 },
            "188600449": { name: "台南轉運站-汽車", lat: 22.999, lng: 120.213 },
            "188600451": { name: "藏壽司員林", lat: 23.959, lng: 120.574 },
            "188600452": { name: "台北內湖", lat: 25.069, lng: 121.586 },
            "188600453": { name: "台中美村南", lat: 24.132, lng: 120.664 },
            "188600454": { name: "燦坤內埔", lat: 22.615, lng: 120.597 },
            "188600455": { name: "寶家潮州", lat: 22.550, lng: 120.543 },
            "188600456": { name: "家福豐南", lat: 24.243, lng: 120.723 },
            "188600458": { name: "燦坤永華", lat: 22.989, lng: 120.184 },
            "188600460": { name: "喜互惠羅莊", lat: 24.757, lng: 121.753 },
            "188600461": { name: "喜互惠文化", lat: 24.758, lng: 121.752 },
            "188600462": { name: "喜互惠慈安", lat: 24.766, lng: 121.748 },
            "188600463": { name: "寶雅內壢", lat: 24.971, lng: 121.258 },
            "188600464": { name: "雀客花蓮", lat: 23.994, lng: 121.631 },
            "188600465": { name: "寶雅鳳山五福", lat: 22.630, lng: 120.352 },
            "188600466": { name: "嘉義新民2", lat: 23.481, lng: 120.448 },
            "188600467": { name: "迪卡儂", lat: 25.054, lng: 121.368 },
            "188600468": { name: "喜互惠頭城", lat: 24.857, lng: 121.824 },
            "188600469": { name: "喜互惠和平", lat: 24.309, lng: 121.745 },
            "188600471": { name: "藏壽司中清", lat: 24.176, lng: 120.662 },
            "188600472": { name: "藏壽司福科", lat: 24.184, lng: 120.614 },
            "188600473": { name: "藏壽司惠文", lat: 24.149, lng: 120.644 },
            "188600474": { name: "藏壽司沙鹿", lat: 24.237, lng: 120.561 },
            "188600475": { name: "藏壽司嘉義", lat: 23.485, lng: 120.441 },
            "188600476": { name: "藏壽司頭份", lat: 24.688, lng: 120.904 },
            "188600477": { name: "藏壽司開元", lat: 23.012, lng: 120.226 },
            "188600478": { name: "藏壽司楠梓藍田", lat: 22.727, lng: 120.326 },
            "188600479": { name: "淡水新民", lat: 25.177, lng: 121.439 },
            "188600480": { name: "林口仁愛二場", lat: 25.077, lng: 121.360 },
            "188600481": { name: "燦坤彰化", lat: 24.081, lng: 120.542 },
            "188600483": { name: "北斗中山場", lat: 23.877, lng: 120.525 },
            "188600484": { name: "新店北新場", lat: 24.967, lng: 121.543 },
            "188600485": { name: "蘆洲中山場", lat: 25.091, lng: 121.464 },
            "188600486": { name: "燦坤光復場", lat: 25.043, lng: 121.557 },
            "188600487": { name: "燦坤瑞隆", lat: 22.609, lng: 120.331 },
            "188600488": { name: "員林國宅場", lat: 23.959, lng: 120.574 },
            "188600489": { name: "燦坤彰化場", lat: 24.081, lng: 120.542 },
            "188600490": { name: "景平天空", lat: 24.992, lng: 121.519 },
            "188600491": { name: "牛埔東", lat: 22.681, lng: 120.307 },
            "188600492": { name: "燦坤南崁", lat: 25.048, lng: 121.287 },
            "188600493": { name: "台中大里", lat: 24.099, lng: 120.679 },
            "188600494": { name: "家福龍安", lat: 24.957, lng: 121.225 },
            "188600495": { name: "家福自由", lat: 25.022, lng: 121.533 },
            "188600496": { name: "家福重和", lat: 25.065, lng: 121.483 },
            "188600504": { name: "寶雅惠民", lat: 22.622, lng: 120.301 },
            "188600505": { name: "高雄博愛", lat: 22.669, lng: 120.302 },
            "188600516": { name: "燦坤豐樂", lat: 24.147, lng: 120.641 },
            "188600536": { name: "水上中興", lat: 23.431, lng: 120.397 },
            "188600539": { name: "淡水中山場", lat: 25.177, lng: 121.439 },
            "188600540": { name: "台南郡平場", lat: 22.980, lng: 120.185 }
        };
        
        // 全域變數
        const lotCodes = Object.keys(parkingLots);
        let userLocation = null;
        let selectedParking = null; // 用戶選擇的停車場
        let parkingData = {}; // 儲存車位資料
        let countdown = refreshInterval;
        let updateTimer = null;
        
        // DOM元素
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationInfo = document.getElementById('location-info');
        const addressInputContainer = document.getElementById('address-input-container');
        const addressInputField = document.getElementById('address-input-field');
        const useAddressBtn = document.getElementById('use-address-btn');
        const locationPermissionHelp = document.getElementById('location-permission-help');
        const selectedParkingElement = document.getElementById('selected-parking');
        const selectedName = document.getElementById('selected-name');
        const selectedId = document.getElementById('selected-id');
        const selectedSpaces = document.getElementById('selected-spaces');
        const selectedStatus = document.getElementById('selected-status');
        const distanceBadge = document.getElementById('distance-badge');
        const navigateBtn = document.getElementById('navigate-btn');
        const copyAddressBtn = document.getElementById('copy-address-btn');
        const parkingList = document.getElementById('parking-list');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const countdownElement = document.getElementById('countdown');
        const lastUpdateElement = document.getElementById('last-update');
        const availableCountElement = document.getElementById('available-count');
        
        // 計算兩個座標之間的距離（使用Haversine公式，單位：公里）
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 地球半徑（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // 使用地址進行地理編碼 - 改進版
        async function geocodeAddress(address) {
            if (!address || address.trim() === '') {
                showError('請輸入地址');
                return null;
            }
            
            try {
                // 顯示載入狀態
                useAddressBtn.innerHTML = '<div class="spinner"></div> 定位中...';
                useAddressBtn.classList.add('btn-disabled');
                useAddressBtn.disabled = true;
                
                // 首先嘗試使用地理編碼服務
                const geocodeResult = await tryMultipleGeocodingMethods(address);
                
                // 恢復按鈕狀態
                useAddressBtn.innerHTML = '<i class="fas fa-search-location"></i> 使用此地址定位';
                useAddressBtn.classList.remove('btn-disabled');
                useAddressBtn.disabled = false;
                
                return geocodeResult;
            } catch (error) {
                console.error('地理編碼錯誤:', error);
                
                // 恢復按鈕狀態
                useAddressBtn.innerHTML = '<i class="fas fa-search-location"></i> 使用此地址定位';
                useAddressBtn.classList.remove('btn-disabled');
                useAddressBtn.disabled = false;
                
                showError('地址定位失敗，請檢查網路或使用預設位置');
                return null;
            }
        }
        
        // 嘗試多種地理編碼方法
        async function tryMultipleGeocodingMethods(address) {
            // 方法1: 使用Nominatim (OpenStreetMap)
            const nominatimResult = await geocodeWithNominatim(address);
            if (nominatimResult) return nominatimResult;
            
            // 方法2: 如果地址包含"新店中正路"但沒找到，嘗試尋找"新店區中正路"
            if (address.includes('新店') && address.includes('中正路')) {
                const modifiedAddress = address.replace('新店', '新店區');
                const modifiedResult = await geocodeWithNominatim(modifiedAddress);
                if (modifiedResult) return modifiedResult;
            }
            
            // 方法3: 嘗試只保留主要路名和區域
            const simplifiedAddress = simplifyTaiwanAddress(address);
            if (simplifiedAddress !== address) {
                const simplifiedResult = await geocodeWithNominatim(simplifiedAddress);
                if (simplifiedResult) return simplifiedResult;
            }
            
            // 方法4: 嘗試使用地標搜尋
            const landmarkResult = await searchLandmark(address);
            if (landmarkResult) return landmarkResult;
            
            // 所有方法都失敗
            throw new Error('找不到此地址');
        }
        
        // 使用Nominatim進行地理編碼
        async function geocodeWithNominatim(address) {
            try {
                // 確保地址包含台灣
                const searchAddress = address.includes('台灣') ? address : `${address}, 台灣`;
                const encodedAddress = encodeURIComponent(searchAddress);
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&accept-language=zh-TW&countrycodes=tw`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'ParkingNavigator/1.0',
                        'Accept-Language': 'zh-TW,zh;q=0.9'
                    }
                });
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    // 取得較簡潔的顯示名稱
                    let displayName = data[0].display_name;
                    // 只取前兩個部分，避免太長
                    const parts = displayName.split(',').slice(0, 2).join(',');
                    
                    return {
                        lat,
                        lng,
                        address: parts,
                        fullAddress: displayName,
                        source: 'nominatim'
                    };
                }
                return null;
            } catch (error) {
                console.error('Nominatim地理編碼錯誤:', error);
                return null;
            }
        }
        
        // 簡化台灣地址
        function simplifyTaiwanAddress(address) {
            // 移除巷弄號碼，只保留主要路名
            let simplified = address;
            
            // 移除巷、弄、號等詳細資訊
            simplified = simplified.replace(/\d+巷/g, '');
            simplified = simplified.replace(/\d+弄/g, '');
            simplified = simplified.replace(/\d+號/g, '');
            
            // 移除多餘的空格
            simplified = simplified.replace(/\s+/g, ' ').trim();
            
            // 確保包含"區"字
            if (simplified.includes('新店') && !simplified.includes('新店區')) {
                simplified = simplified.replace('新店', '新店區');
            }
            
            return simplified;
        }
        
        // 搜尋地標
        async function searchLandmark(address) {
            try {
                // 常見地標對照表
                const landmarks = {
                    '新店中正路': { lat: 24.9675, lng: 121.5432, name: '新店區中正路' },
                    '新店捷運站': { lat: 24.9678, lng: 121.5415, name: '新店捷運站' },
                    '新店區公所': { lat: 24.9692, lng: 121.5411, name: '新店區公所' },
                    '新店高中': { lat: 24.9715, lng: 121.5402, name: '新店高中' },
                    '碧潭': { lat: 24.9564, lng: 121.5369, name: '碧潭' },
                    '新店慈濟醫院': { lat: 24.9805, lng: 121.5385, name: '新店慈濟醫院' }
                };
                
                // 檢查地址是否包含已知地標
                for (const [landmark, data] of Object.entries(landmarks)) {
                    if (address.includes(landmark)) {
                        return {
                            lat: data.lat,
                            lng: data.lng,
                            address: data.name,
                            fullAddress: data.name,
                            source: 'landmark'
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('地標搜尋錯誤:', error);
                return null;
            }
        }
        
        // 顯示錯誤訊息
        function showError(message) {
            locationInfo.innerHTML = `
                <div style="color:#ef4444; margin-bottom: 10px;">
                    <strong>${message}</strong>
                </div>
                <div style="font-size: 0.85rem; color: #64748b;">
                    <p><strong>建議：</strong></p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>輸入更完整的地址，例如：<strong>新北市新店區安和路三段37號</strong></li>
                        <li>或只輸入路名和區域，例如：<strong>新店區中正路</strong></li>
                        <li>也可以輸入地標，例如：<strong>新店七張捷運站</strong></li>
                        <li>或者使用下方的預設位置按鈕</li>
                    </ul>
                </div>
            `;
        }
        
        // 顯示成功訊息
        function showSuccess(message) {
            locationInfo.innerHTML = `<div style="color:#10b981;"><strong>${message}</strong></div>`;
        }
        
        // 使用地址定位
        async function useAddressForLocation() {
            const address = addressInputField.value.trim();
            if (!address) {
                showError('請輸入地址');
                return;
            }
            
            const geocodeResult = await geocodeAddress(address);
            if (geocodeResult) {
                userLocation = { lat: geocodeResult.lat, lng: geocodeResult.lng };
                locationInfo.innerHTML = `
                    <div style="color:#10b981; margin-bottom: 5px;">
                        <strong>地址定位成功！</strong>
                    </div>
                    <div style="font-size: 0.9rem;">
                        位置: ${geocodeResult.address}<br>
                        緯度: ${geocodeResult.lat.toFixed(6)}, 經度: ${geocodeResult.lng.toFixed(6)}
                    </div>
                `;
                locationPermissionHelp.style.display = 'none';
                
                // 更新停車場列表
                updateParkingList(userLocation);
                
                // 不要自動選擇最近的停車場
                // selectNearestParking();
            }
        }
        
        // 取得使用者位置 - iPhone 修正版
        function getUserLocation() {
            if (!navigator.geolocation) {
                locationInfo.innerHTML = '<span style="color:#ef4444;">您的瀏覽器不支援地理定位功能</span>';
                locationPermissionHelp.style.display = 'block';
                addressInputContainer.classList.add('active');
                return;
            }
            
            // 顯示載入狀態
            getLocationBtn.innerHTML = '<div class="loading"></div> 定位中...';
            getLocationBtn.classList.add('btn-disabled');
            getLocationBtn.disabled = true;
            
            // 增加超時時間，給用戶更多時間授權
            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // 15秒超時
                maximumAge: 0
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 成功取得位置
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // 顯示位置資訊
                    locationInfo.innerHTML = `緯度: ${lat.toFixed(6)}, 經度: ${lng.toFixed(6)}`;
                    locationPermissionHelp.style.display = 'none';
                    addressInputContainer.classList.remove('active');
                    
                    // 恢復按鈕狀態
                    getLocationBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> 重新定位';
                    getLocationBtn.classList.remove('btn-disabled');
                    getLocationBtn.disabled = false;
                    
                    // 更新停車場列表
                    updateParkingList(userLocation);
                    
                    // 不要自動選擇最近的停車場
                    // if (!selectedParking) {
                    //     selectNearestParking();
                    // }
                },
                (error) => {
                    // 取得位置失敗
                    let errorMessage = "無法取得您的位置";
                    let errorDetails = "";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "您拒絕了位置存取權限";
                            errorDetails = "請使用地址定位功能或選擇預設位置。";
                            // 顯示地址輸入框
                            addressInputContainer.classList.add('active');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "位置資訊不可用";
                            errorDetails = "請檢查您的裝置定位功能是否已開啟，或使用地址定位。";
                            addressInputContainer.classList.add('active');
                            break;
                        case error.TIMEOUT:
                            errorMessage = "取得位置超時";
                            errorDetails = "定位時間過長，請重試或使用地址定位。";
                            addressInputContainer.classList.add('active');
                            break;
                    }
                    
                    locationInfo.innerHTML = `
                        <div style="color:#ef4444; margin-bottom:10px;">
                            <strong>${errorMessage}</strong><br>
                            <small>${errorDetails}</small>
                        </div>
                    `;
                    locationPermissionHelp.style.display = 'block';
                    
                    // 恢復按鈕狀態
                    getLocationBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> 重新取得位置';
                    getLocationBtn.classList.remove('btn-disabled');
                    getLocationBtn.disabled = false;
                },
                options
            );
        }
        
        // 選擇最近的停車場
        function selectNearestParking() {
            if (!userLocation) return;
            
            let minDistance = Infinity;
            let nearest = null;
            
            for (const [id, parking] of Object.entries(parkingLots)) {
                const distance = calculateDistance(
                    userLocation.lat, 
                    userLocation.lng, 
                    parking.lat, 
                    parking.lng
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { id, ...parking, distance };
                }
            }
            
            if (nearest) {
                selectedParking = nearest;
                updateSelectedParking(nearest);
            }
        }
        
        // 使用預設位置（台北車站）
        function useTaipeiStation() {
            userLocation = { lat: 25.047675, lng: 121.517055 }; // 台北車站座標
            locationInfo.innerHTML = `緯度: ${userLocation.lat.toFixed(6)}, 經度: ${userLocation.lng.toFixed(6)} (預設位置-台北車站)`;
            locationPermissionHelp.style.display = 'none';
            addressInputContainer.classList.remove('active');
            
            // 更新停車場列表
            updateParkingList(userLocation);
            
            // 不要自動選擇最近的停車場
            // selectNearestParking();
        }
        
        // 使用台北101位置
        function useTaipei101() {
            userLocation = { lat: 25.0339639, lng: 121.5644722 }; // 台北101座標
            locationInfo.innerHTML = `緯度: ${userLocation.lat.toFixed(6)}, 經度: ${userLocation.lng.toFixed(6)} (預設位置-台北101)`;
            locationPermissionHelp.style.display = 'none';
            addressInputContainer.classList.remove('active');
            
            // 更新停車場列表
            updateParkingList(userLocation);
            
            // 不要自動選擇最近的停車場
            // selectNearestParking();
        }
        
        // 使用高雄車站位置
        function useKaohsiung() {
            userLocation = { lat: 22.639444, lng: 120.302778 }; // 高雄車站座標
            locationInfo.innerHTML = `緯度: ${userLocation.lat.toFixed(6)}, 經度: ${userLocation.lng.toFixed(6)} (預設位置-高雄車站)`;
            locationPermissionHelp.style.display = 'none';
            addressInputContainer.classList.remove('active');
            
            // 更新停車場列表
            updateParkingList(userLocation);
            
            // 不要自動選擇最近的停車場
            // selectNearestParking();
        }
        
        // 更新選中的停車場資訊
        function updateSelectedParking(parking) {
            selectedName.textContent = parking.name;
            selectedId.textContent = parking.id;
            
            // 計算距離
            if (userLocation) {
                const distance = calculateDistance(
                    userLocation.lat, 
                    userLocation.lng, 
                    parking.lat, 
                    parking.lng
                );
                
                let distanceText;
                if (distance < 1) {
                    distanceText = `約 ${Math.round(distance * 1000)} 公尺`;
                } else {
                    distanceText = `約 ${distance.toFixed(1)} 公里`;
                }
                
                distanceBadge.textContent = distanceText;
            }
            
            // 更新車位資訊
            if (parkingData[parking.id]) {
                updateSelectedParkingInfo(parking.id);
            } else {
                selectedSpaces.textContent = '-- / --';
                selectedStatus.innerHTML = '<span class="status-label loading">載入中</span>';
            }
            
            selectedParkingElement.classList.add('active');
            
            // 啟用導航和複製按鈕
            navigateBtn.disabled = false;
            navigateBtn.classList.remove('btn-disabled');
            copyAddressBtn.disabled = false;
            copyAddressBtn.classList.remove('btn-disabled');
        }
        
        // 更新選中停車場的車位資訊
        function updateSelectedParkingInfo(parkingId) {
            const data = parkingData[parkingId];
            if (data) {
                selectedSpaces.textContent = `${data.freeSpace} / ${data.totalSpace}`;
                
                if (data.freeSpace > 0) {
                    selectedStatus.innerHTML = '<span class="status-label available">可停</span>';
                    distanceBadge.className = 'distance-badge status-available';
                } else {
                    selectedStatus.innerHTML = '<span class="status-label full">已滿</span>';
                    distanceBadge.className = 'distance-badge status-full';
                }
            }
        }
        
        // 更新停車場列表
        function updateParkingList(userLocation) {
            // 清空列表
            parkingList.innerHTML = '';
            
            // 創建停車場陣列並計算距離
            const parkingArray = Object.entries(parkingLots).map(([id, parking]) => {
                const distance = calculateDistance(
                    userLocation.lat, 
                    userLocation.lng, 
                    parking.lat, 
                    parking.lng
                );
                return { id, ...parking, distance };
            });
            
            // 按距離排序（由近到遠）
            parkingArray.sort((a, b) => a.distance - b.distance);
            
            // 更新可用停車場計數
            let availableCount = 0;
            
            // 生成列表項目
            parkingArray.forEach(parking => {
                const item = document.createElement('div');
                item.className = 'parking-item';
                
                // 檢查是否為選中的停車場
                if (selectedParking && selectedParking.id === parking.id) {
                    item.classList.add('selected');
                }
                
                // 格式化距離
                let distanceText;
                let statusText = '<span class="status-label loading">載入中</span>';
                let spacesText = '-- / --';
                
                if (parking.distance < 1) {
                    distanceText = `${Math.round(parking.distance * 1000)} 公尺`;
                } else {
                    distanceText = `${parking.distance.toFixed(1)} 公里`;
                }
                
                // 檢查是否有車位資料
                if (parkingData[parking.id]) {
                    const data = parkingData[parking.id];
                    spacesText = `${data.freeSpace} / ${data.totalSpace}`;
                    
                    if (data.freeSpace > 0) {
                        statusText = '<span class="status-label available">可停</span>';
                        availableCount++;
                    } else {
                        statusText = '<span class="status-label full">已滿</span>';
                    }
                }
                
                item.innerHTML = `
                    <div class="parking-info">
                        <div class="parking-name">${parking.name}</div>
                        <div class="parking-id">編號: ${parking.id}</div>
                        <div class="parking-distance">${distanceText}</div>
                    </div>
                    <div class="parking-status">
                        <div class="spaces-count">${spacesText}</div>
                        ${statusText}
                    </div>
                `;
                
                // 添加點擊事件
                item.addEventListener('click', () => {
                    // 移除所有項目的選中狀態
                    document.querySelectorAll('.parking-item').forEach(pItem => {
                        pItem.classList.remove('selected');
                    });
                    
                    // 添加當前項目的選中狀態
                    item.classList.add('selected');
                    
                    // 設定為選中的停車場
                    selectedParking = parking;
                    
                    // 更新選中停車場區塊
                    updateSelectedParking(parking);
                    
                    // 滾動到選中停車場區塊
                    selectedParkingElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                
                parkingList.appendChild(item);
            });
            
            // 更新可用停車場計數
            availableCountElement.textContent = `可用: ${availableCount}`;
        }
        
        // 開啟Google Maps導航 - 修正版
        function openGoogleMapsNavigation() {
            if (!selectedParking) {
                alert('請先點擊選擇一個停車場作為導航目的地');
                return;
            }
            
            if (!userLocation) {
                alert('請先取得您的位置');
                return;
            }
            
            // Google Maps導航URL - 修正版：使用直接導航模式
            // 方式1: 使用 maps/dir/ 模式 (會顯示路線規劃，然後可以點擊開始導航)
            const origin = `${userLocation.lat},${userLocation.lng}`;
            const destination = `${selectedParking.lat},${selectedParking.lng}`;
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
            
            // 方式2: 也可以嘗試使用 navigation 模式 (在某些裝置上會直接啟動導航)
            // const navUrl = `https://www.google.com/maps/search/?api=1&query=${selectedParking.lat},${selectedParking.lng}&query_place_id=${selectedParking.id}`;
            
            // 方式3: 使用 maps/dir/ 並加上 dir_action=navigate 參數
            // const navUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving&dir_action=navigate`;
            
            // 開啟新分頁
            window.open(url, '_blank');
            
            // 在手機上，如果安裝了Google Maps App，可能會自動開啟App
            // 以下是嘗試在移動裝置上直接開啟App的備用方案
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                // 嘗試使用 universal link 開啟 Google Maps App
                const appUrl = `comgooglemaps://?saddr=${origin}&daddr=${destination}&directionsmode=driving`;
                const appUrlAndroid = `google.navigation:q=${selectedParking.lat},${selectedParking.lng}&mode=d`;
                
                setTimeout(() => {
                    // 嘗試開啟App，如果失敗則會回到網頁版本
                    window.location = appUrl;
                }, 1000);
            }
        }
        
        // 複製地址到剪貼簿
        function copyAddressToClipboard() {
            if (!selectedParking) {
                alert('請先選擇一個停車場');
                return;
            }
            
            // 取得詳細地址（如果有的話）
            const text = `${selectedParking.name}\n停車場編號: ${selectedParking.id}`;
            
            // 使用Clipboard API
            navigator.clipboard.writeText(text)
                .then(() => {
                    // 顯示成功訊息
                    const originalText = copyAddressBtn.innerHTML;
                    copyAddressBtn.innerHTML = '<i class="fas fa-check"></i> 已複製';
                    copyAddressBtn.style.backgroundColor = '#10b981';
                    
                    setTimeout(() => {
                        copyAddressBtn.innerHTML = originalText;
                        copyAddressBtn.style.backgroundColor = '';
                    }, 2000);
                })
                .catch(err => {
                    console.error('複製失敗: ', err);
                    // 備用方案：使用 document.execCommand
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('地址已複製到剪貼簿');
                    } catch (e) {
                        alert('複製失敗，請手動複製地址');
                    }
                    document.body.removeChild(textArea);
                });
        }
        
        // API查詢函數 - 獲取停車場資訊
        async function fetchParkInfo(lotCode) {
            try {
                const res = await fetch("https://gpark.keytop.cn/nkc/index/getParkInfo", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "kt-token": token,
                        "kt-appId": "16bbf366b49a48fab362b7f163d96c63",
                        "kt-lotcodes": lotCode,
                        "authCode": "index/getParkInfo",
                        "client-flag": "PC",
                    },
                    body: JSON.stringify({ lotCode })
                });
                const data = await res.json();
                if (data.resultCode === 200 && data.data) {
                    return {
                        lotCode: lotCode,
                        name: parkingLots[lotCode]?.name || "未知場站",
                        freeSpace: data.data.freeSpace,
                        totalSpace: data.data.totalSpace,
                        status: data.data.freeSpace > 0 ? "available" : "full"
                    };
                } else {
                    return null;
                }
            } catch (error) {
                console.error(`查詢 ${lotCode} 失敗:`, error);
                return null;
            }
        }
        
        // 更新所有停車場車位資訊
        async function updateAllParkingSpaces() {
            // 顯示進度條
            progressContainer.classList.add('active');
            progressBar.value = 0;
            progressText.textContent = "開始查詢...";
            
            let successCount = 0;
            
            // 重置停車場資料
            parkingData = {};
            
            for (let i = 0; i < lotCodes.length; i++) {
                const lotCode = lotCodes[i];
                const info = await fetchParkInfo(lotCode);
                
                if (info) {
                    // 儲存資料
                    parkingData[lotCode] = {
                        freeSpace: info.freeSpace,
                        totalSpace: info.totalSpace
                    };
                    
                    successCount++;
                }
                
                // 更新進度條
                //progressBar.value = Math.round(((i + 1) / lotCodes.length) * 100);
                //progressText.textContent = `已完成 ${i + 1}/${lotCodes.length} 場站查詢`;
            }
            
            // 更新顯示
            progressText.textContent = `查詢完成 ✅ (成功: ${successCount}/${lotCodes.length})`;
            
            // 1秒後隱藏進度條
            setTimeout(() => {
                progressContainer.classList.remove('active');
            }, 1000);
            
            // 更新選中的停車場資訊
            if (selectedParking) {
                updateSelectedParkingInfo(selectedParking.id);
            }
            
            // 更新停車場列表
            if (userLocation) {
                updateParkingList(userLocation);
            }
            
            // 更新最後更新時間
            const now = new Date();
            lastUpdateElement.textContent = now.toLocaleTimeString('zh-TW');
            
            // 重置倒數計時
            countdown = refreshInterval;
        }
        
        // 倒數計時更新
        function startCountdown() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            updateTimer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    updateAllParkingSpaces();
                }
            }, 1000);
        }
        
        // 初始化頁面
        function initPage() {
            // 綁定按鈕事件
            getLocationBtn.addEventListener('click', getUserLocation);
            useAddressBtn.addEventListener('click', useAddressForLocation);
            navigateBtn.addEventListener('click', openGoogleMapsNavigation);
            copyAddressBtn.addEventListener('click', copyAddressToClipboard);
            
            // 綁定預設位置按鈕
            document.getElementById('use-taipei-station').addEventListener('click', useTaipeiStation);
            document.getElementById('use-taipei101').addEventListener('click', useTaipei101);
            document.getElementById('use-kaohsiung').addEventListener('click', useKaohsiung);
            
            // 允許按Enter鍵進行地址定位
            addressInputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    useAddressForLocation();
                }
            });
            
            // 預設使用台北車站位置
            useTaipeiStation();
            
            // 開始更新車位資訊
            updateAllParkingSpaces();
            
            // 啟動倒數計時
            startCountdown();
            
            // 檢查地理位置支援
            if (!navigator.geolocation) {
                locationInfo.innerHTML = '<span style="color:#ef4444;">您的瀏覽器不支援地理定位功能，請使用地址定位。</span>';
                locationPermissionHelp.style.display = 'block';
                addressInputContainer.classList.add('active');
            }
            
            // 初始隱藏選中停車場區塊
            selectedParkingElement.classList.remove('active');
            
            // 初始禁用導航和複製按鈕
            navigateBtn.disabled = true;
            navigateBtn.classList.add('btn-disabled');
            copyAddressBtn.disabled = true;
            copyAddressBtn.classList.add('btn-disabled');
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
