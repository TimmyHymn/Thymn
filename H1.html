<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>網頁版詩歌</title>
    <style>
        /* 基本重置樣式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: Verdana, sans-serif;
            height: 100%;
            width: 100%;
            background-color: #f7f7f7;
        }

        /* 表格佈局 */
        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        td {
            padding: 2px;
        }

        /* 按鈕樣式 */
        input[type="button"] {
            width: 100%;
            height: 100%;
            font-size: 6vw;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        input[type="button"]:hover {
            background-color: #e0e0e0;
        }

        .btn-blue, .btn-yellow, .btn-red, .btn-green {
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-blue {
            background: linear-gradient(145deg, #0066cc, #003399);
        }

        .btn-yellow {
            background: linear-gradient(145deg, #ffcc00, #cc9900);
        }

        .btn-red {
            background: linear-gradient(145deg, #ff3333, #cc0000);
        }

        .btn-green {
            background: linear-gradient(145deg, #33cc33, #009900);
        }

        .btn-3d {
            box-shadow: 0 5px #666;
        }

        .btn-3d:active {
            box-shadow: 0 2px #666;
            transform: translateY(4px);
        }

        /* 顯示區域樣式 */
        #SHOW {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 200px;
            display: block;
        }

        /* 搜尋區域樣式 */
        #search-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        #search-input {
            width: 80%;
            padding: 10px;
            font-size: 6vw;
        }

        #search-button {
            padding: 10px 20px;
            font-size: 6vw;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 主介面表格 -->
    <table>
        <tr>
            <td><input type="button" id="book-display" value="" class="btn-blue" style="color: yellow; border-radius: 50px;" disabled></td>
            <td><input type="button" id="book-number" value="" class="btn-blue" style="color: yellow; border-radius: 50px;" disabled></td>
            <td><input type="button" value="?" class="D"></td>
            <td><input type="button" value="目錄" class="btn-blue" onclick="showDirectory()"></td>
        </tr>
        <tr>
            <td><input type="button" value="詩歌" class="btn-blue btn-3d" onclick="showBookName(1, '詩歌')"></td>
            <td><input type="button" value="1" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="2" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="3" class="btn-yellow btn-3d"></td>
        </tr>
        <tr>
            <td><input type="button" value="補充" class="btn-blue btn-3d" onclick="showBookName(2, '補充')"></td>
            <td><input type="button" value="4" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="5" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="6" class="btn-yellow btn-3d"></td>
        </tr>
        <tr>
            <td><input type="button" value="新頌" class="btn-blue btn-3d" onclick="showBookName(3, '新頌')"></td>
            <td><input type="button" value="7" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="8" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="9" class="btn-yellow btn-3d"></td>
        </tr>
        <tr>
            <td><input type="button" value="紅本" class="btn-blue btn-3d" onclick="showBookName(4, '紅本')"></td>
            <td><input type="button" value="清除" class="btn-red btn-3d"></td>
            <td><input type="button" value="0" class="btn-yellow btn-3d"></td>
            <td><input type="button" value="確認" class="btn-green btn-3d"></td>
        </tr>
        <tr>
            <td><input type="button" value="藍本" class="btn-blue btn-3d" onclick="showBookName(5, '藍本')"></td>
            <td><input type="button" value="兒童" class="btn-blue btn-3d" onclick="showBookName(6, '兒童')"></td>
            <td><input type="button" value="搜尋" class="btn-red btn-3d" onclick="toggleSearch()"></td>
            <td><input type="button" value="說明" class="btn-red btn-3d" onclick="HELPTEXT()"></td>
        </tr>
    </table>

    <!-- 搜尋輸入區 -->
    <div id="search-container">
        <input type="text" id="search-input" placeholder="輸入搜尋關鍵字...">
        <button id="search-button" class="btn-blue" onclick="search()">搜尋</button>
    </div>

    <!-- 顯示區域 -->
    <div id="SHOW"></div>

    <script>
        // 版本控制
        const currentVersion = 20250311;
        const storedVersion = localStorage.getItem('hymnsVersion');
        if (storedVersion !== String(currentVersion)) {
            const script = document.createElement('script');
            script.src = storedVersion === null ? 'hymns.js' : 'replacedata.js';
            document.head.appendChild(script);
            localStorage.setItem('hymnsVersion', String(currentVersion));
        }

        // 顯示歌本名稱
        function showBookName(bookCode, bookName) {
            document.getElementById('book-display').value = bookName;
            document.getElementById('SHOW').innerHTML = '';
            document.getElementById('SHOW').style.display = 'none';
        }

        // 格式化歌詞
        function formatLyrics(lyrics) {
            const lines = lyrics.split('\n');
            let longestLine = '';
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > longestLine.length) longestLine = lines[i];
            }
            const screenWidth = window.innerWidth;
            const charCount = longestLine.length;
            const fontSize = (screenWidth / charCount) * 0.9;
            let formattedLyrics = '';
            for (let i = 0; i < lines.length; i++) {
                formattedLyrics += i === 0 
                    ? `<div style="font-size: ${fontSize}px; color: red;">${lines[i]}</div>`
                    : `<div style="font-size: ${fontSize}px;">${lines[i]}</div>`;
            }
            return formattedLyrics;
        }

        // 搜尋歌詞
        function searchLyrics(book, code) {
            const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
            const bookCodeMap = { '詩歌': 1, '補充': 2, '新頌': 3, '紅本': 4, '兒童': 5, '藍本': 6 };
            const hymn = hymns.find(h => h.book === bookCodeMap[book] && h.code === code);
            if (hymn) {
                const formattedLyrics = formatLyrics(hymn.lyrics);
                let result = formattedLyrics;
                if (hymn.favorite) {
                    result += `<div style="font-size: 6vw; color: blue; background-color: #BDA589;">上次點歌日期: ${hymn.favorite}</div>`;
                }
                document.getElementById('SHOW').innerHTML = result;
                document.getElementById('SHOW').style.display = 'block';
                document.getElementById('SHOW').scrollIntoView();
            } else {
                alert('找不到對應的歌詞');
            }
        }

        // DOM 載入後事件處理
        document.addEventListener('DOMContentLoaded', function() {
            let numberValue = "";
            const numberDisplay = document.getElementById('book-number');

            function updateNumberDisplay() {
                numberDisplay.value = numberValue;
            }

            // 數字按鈕事件
            document.querySelectorAll('.btn-yellow').forEach(button => {
                button.addEventListener('click', function() {
                    numberValue += this.value;
                    updateNumberDisplay();
                });
            });

            // 刪除最後一位數字
            document.querySelector('.D').addEventListener('click', function() {
                numberValue = numberValue.slice(0, -1);
                updateNumberDisplay();
            });

            // 清除按鈕事件
            document.querySelector('.btn-red').addEventListener('click', function() {
                document.getElementById('book-display').value = '';
                document.getElementById('book-number').value = '';
                numberValue = '';
                updateNumberDisplay();
                document.getElementById('SHOW').innerHTML = '';
                document.getElementById('SHOW').style.display = 'none';
                document.getElementById('search-container').style.display = 'none';
            });

            // 確認按鈕事件
            document.querySelector('.btn-green').addEventListener('click', function() {
                const bookName = document.getElementById('book-display').value;
                const bookNumber = document.getElementById('book-number').value.trim();
                if (!bookName && bookNumber === '9101229') {
                    exportHymnsWithData();
                } else if (bookName && bookNumber) {
                    searchLyrics(bookName, parseInt(bookNumber, 10));
                    const today = new Date();
                    const taiwanYear = today.getFullYear() - 1911;
                    const taiwanDate = `${taiwanYear}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                    const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
                    const bookCodeMap = { '詩歌': 1, '補充': 2, '新頌': 3, '紅本': 4, '兒童': 5, '藍本': 6 };
                    const hymn = hymns.find(h => h.book === bookCodeMap[bookName] && h.code === parseInt(bookNumber, 10));
                    if (hymn) {
                        hymn.favorite = parseInt(taiwanDate, 10);
                        localStorage.setItem('hymns', JSON.stringify(hymns));
                    } else {
                        alert('找不到對應的歌詞');
                    }
                } else {
                    alert("請選擇歌本名稱並輸入歌本號碼。");
                }
            });
        });

        // 顯示說明
        function HELPTEXT() {
            const TimmyMSG = formatLyrics(localStorage.getItem('TimmyMSG'));
            document.getElementById('SHOW').innerHTML = TimmyMSG;
            document.getElementById('SHOW').style.display = 'block';
            document.getElementById('SHOW').scrollIntoView();
        }

        // 切換搜尋框顯示
        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
            if (searchContainer.style.display === 'block') document.getElementById('search-container').scrollIntoView();
        }

        // 搜尋功能
        function search() {
            const keyword = document.getElementById('search-input').value.trim();
            if (!keyword) {
                alert('請輸入搜尋關鍵字');
                return;
            }
            const fontSizeMatch = keyword.match(/^縮小字體(\d+)$/);
            if (fontSizeMatch) {
                const mfontSize = parseInt(fontSizeMatch[1], 10);
                if (!isNaN(mfontSize)) {
                    localStorage.setItem('FS', mfontSize);
                    alert(`字體大小已縮小幾個 ${mfontSize}`);
                    return;
                }
            }
            const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
            const bookCodeMap = { 1: '詩歌', 2: '補充', 3: '新頌', 4: '紅本', 5: '兒童', 6: '藍本' };
            const regex = new RegExp(keyword, 'gi');
            let results = '';
            let lastCode = null;
            hymns.forEach(hymn => {
                let displayTitle = regex.test(hymn.title) || regex.test(hymn.favorite);
                let matchingLine = '';
                const lines = hymn.lyrics.split('\n');
                for (let line of lines) {
                    if (regex.test(line)) {
                        matchingLine = line.replace(regex, match => `<span style="color: red;">${match}</span>`);
                        break;
                    }
                }
                if (displayTitle || matchingLine) {
                    if (lastCode && lastCode !== hymn.code) results += '<br/><br/><br/>';
                    results += `<div style="font-size: 6vw; color: darkblue;">${bookCodeMap[hymn.book]} ${hymn.code}: ${hymn.title.replace(regex, match => `<span style="color: red;">${match}</span>`)}</div>`;
                    if (matchingLine) results += `<div style="font-size: 6vw;">${matchingLine}</div>`;
                    lastCode = hymn.code;
                }
            });
            document.getElementById('SHOW').innerHTML = results || '找不到符合的結果';
            document.getElementById('SHOW').style.display = 'block';
            document.getElementById('search-container').style.display = 'none';
        }

        // 顯示目錄
        function showDirectory() {
            const bookName = document.getElementById('book-display').value;
            if (!bookName) {
                alert("請選擇歌本名稱，然後再按目錄。");
                return;
            }
            const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
            const bookCodeMap = { '詩歌': 1, '補充': 2, '新頌': 3, '紅本': 4, '兒童': 5, '藍本': 6 };
            const bookCode = bookCodeMap[bookName];
            let result = '';
            let currentColor = 'MidnightBlue';
            hymns.forEach(hymn => {
                if (hymn.book === bookCode) {
                    result += `<div style="font-size: 5vw; color: ${currentColor};">${bookName} ${hymn.code}: ${hymn.title}</div><br/><br/><br/>`;
                    currentColor = currentColor === 'MidnightBlue' ? 'DarkGreen' : 'MidnightBlue';
                }
            });
            document.getElementById('SHOW').innerHTML = result || '找不到目錄。';
            document.getElementById('SHOW').style.display = 'block';
            document.getElementById('search-container').style.display = 'none';
            document.getElementById('SHOW').scrollIntoView();
        }

        // 匯出有資料的詩歌
        function exportHymnsWithData() {
            const hymns = JSON.parse(localStorage.getItem('hymns')) || [];
            const filteredHymns = hymns.filter(h => (h.favorite && h.favorite !== 0) || (h.feeling && h.feeling.trim() !== ''));
            const exportString = `const newHymns = ${JSON.stringify(filteredHymns, null, 2)};`;
            const blob = new Blob([exportString], { type: 'application/javascript' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'replacedata.js';
            link.click();
        }
    </script>
</body>
</html>
