<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全車廠車輛記錄批量查詢系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #4a6491;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'Segoe UI', 'Noto Sans TC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-left h1 i {
            color: #4fc3f7;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .header-stats {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            min-width: 300px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.8fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary-color);
            height: fit-content;
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .card-title i {
            color: var(--secondary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #3a5479, #1c2e40);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 100, 145, 0.2);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-full {
            width: 100%;
            margin-top: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .progress-section {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .progress-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .progress-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #555;
            flex-wrap: wrap;
        }
        
        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 1rem;
        }
        
        .current-lot-info {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--info-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .lot-detail {
            display: flex;
            flex-direction: column;
        }
        
        .lot-detail strong {
            color: #0c5460;
            font-size: 0.9rem;
        }
        
        .lot-detail span {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success-color);
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--info-color);
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fdfdfd;
            max-height: 500px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        th {
            background: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f5f9ff;
        }
        
        .record-in {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .record-out {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .record-time {
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .search-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .plates-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .plate-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .active-plate {
            background: var(--secondary-color);
            color: white;
        }
        
        .query-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .setting-item {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
        }
        
        .setting-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .setting-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .summary-card {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .summary-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .summary-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .lot-progress {
            margin-top: 15px;
        }
        
        .lot-progress-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ddd;
        }
        
        .lot-progress-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .lot-name {
            font-weight: 600;
            color: #555;
        }
        
        .lot-status {
            font-weight: 600;
        }
        
        .lot-status-completed {
            color: var(--success-color);
        }
        
        .lot-status-processing {
            color: var(--warning-color);
        }
        
        .lot-status-pending {
            color: #999;
        }
        
        .lot-status-error {
            color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-stats {
                width: 100%;
                justify-content: space-around;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .progress-stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-car"></i> 全車廠車輛記錄批量查詢系統</h1>
                    <p>輸入車牌號碼，系統將在所有車廠中查詢完全匹配的進出記錄</p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-label">總車廠數</div>
                        <div id="total-lots" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">總記錄數</div>
                        <div id="total-records" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">查詢時間</div>
                        <div id="total-time" class="stat-value">0秒</div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 進度條區域 -->
        <div class="progress-section">
            <div class="progress-header">
                <div class="progress-title">查詢進度</div>
                <div class="progress-stats">
                    <div>狀態: <span id="progress-status">就緒</span></div>
                    <div>已查詢車廠: <span id="lots-processed">0</span>/<span id="total-lots-count">0</span></div>
                    <div>已獲取記錄: <span id="progress-records">0</span> 筆</div>
                    <div>用時: <span id="progress-time">0秒</span></div>
                </div>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
        </div>
        
        <div class="main-content">
            <!-- 左側控制面板 -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-cogs"></i> 查詢設定</h2>
                
                <div class="form-group">
                    <label for="plate-input" class="form-label">車牌號碼 <small>(完全匹配，多個車牌用逗號或換行分隔)</small></label>
                    <textarea id="plate-input" class="form-control" rows="4" placeholder="例如: AAB8316, AAC6896, AAG6831&#10;每行一個車牌或逗號分隔"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="year-month-input" class="form-label">查詢年月範圍</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="month" id="year-month-start" class="form-control" value="2025-01">
                        <span>至</span>
                        <input type="month" id="year-month-end" class="form-control" value="2025-12">
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">選擇要查詢的起始和結束年月</small>
                </div>
                
                <div class="query-settings">
                    <div class="setting-item">
                        <div class="setting-label">每頁記錄數</div>
                        <div class="setting-value">500 筆/頁</div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">CK_Timmy</div>
                        <div class="setting-value">已設定 (固定)</div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">匹配模式</div>
                        <div class="setting-value">完全匹配</div>
                    </div>
                </div>
                
                <button id="search-btn" class="btn btn-primary btn-full">
                    <i class="fas fa-search"></i> 開始全車廠查詢
                </button>
                
                <div class="current-lot-info" style="display: none;" id="current-lot-info">
                    <div class="lot-detail">
                        <strong>當前查詢車廠</strong>
                        <span id="current-lot-name">-</span>
                    </div>
                    <div class="lot-detail">
                        <strong>車廠ID</strong>
                        <span id="current-lot-id">-</span>
                    </div>
                    <div class="lot-detail">
                        <strong>查詢進度</strong>
                        <span id="current-lot-progress">-</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="export-json-btn" class="btn btn-success">
                        <i class="fas fa-file-code"></i> JSON
                    </button>
                    <button id="export-csv-btn" class="btn btn-success">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button id="export-excel-btn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button id="clear-results-btn" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> 清除結果
                    </button>
                </div>
                
                <div class="summary-card">
                    <div class="summary-title">查詢摘要</div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div id="summary-lots" class="summary-value">0</div>
                            <div class="summary-label">已查詢車廠</div>
                        </div>
                        <div class="summary-stat">
                            <div id="summary-plates" class="summary-value">0</div>
                            <div class="summary-label">查詢車牌數</div>
                        </div>
                        <div class="summary-stat">
                            <div id="summary-records" class="summary-value">0</div>
                            <div class="summary-label">找到記錄數</div>
                        </div>
                        <div class="summary-stat">
                            <div id="summary-time" class="summary-value">0s</div>
                            <div class="summary-label">查詢用時</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右側結果區域 -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-list-alt"></i> 查詢結果</h2>
                
                <div id="alert-area"></div>
                
                <div id="search-summary" class="search-summary" style="display: none;">
                    <div>
                        <h3>查詢摘要</h3>
                        <p id="summary-text">正在查詢...</p>
                        <div class="plates-container" id="active-plates"></div>
                    </div>
                </div>
                
                <div class="results-container">
                    <div id="no-results" class="no-results">
                        <i class="fas fa-car"></i>
                        <h3>暫無查詢結果</h3>
                        <p>輸入車牌號碼和查詢年月，然後點擊"開始全車廠查詢"按鈕</p>
                    </div>
                    
                    <div id="results-table" class="table-container" style="display: none;">
                        <table id="records-table">
                            <thead>
                                <tr>
                                    <th>車牌</th>
                                    <th>方向</th>
                                    <th>時間</th>
                                    <th>車輛類型</th>
                                    <th>放行方式</th>
                                    <th>通道</th>
                                    <th>車廠</th>
                                    <th>備註</th>
                                </tr>
                            </thead>
                            <tbody id="records-body">
                                <!-- 記錄將動態插入這裡 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="lot-progress" id="lot-progress-container" style="display: none;">
                    <h4>車廠查詢進度</h4>
                    <div id="lot-progress-list">
                        <!-- 車廠進度條將動態插入這裡 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 固定配置
        const FIXED_TOKEN = "ilbnrfsjr6a0fnq20wyz50dtrqp3jah5zohmxwagr237blsilz59zqco3g570lgner1uc8uwck1";
        const PAGE_SIZE = 500; // 每頁500筆
        
        // 車廠信息
        const lotCodes = [
            "188600531","188600535",
            "188600343","188600416","188600417","188600418","188600419",
            "188600420","188600421","188600422","188600423","188600424",
            "188600425","188600426","188600427","188600428","188600429",
            "188600431","188600432","188600433","188600434","188600435",
            "188600436","188600437","188600438","188600439","188600440",
            "188600442","188600443","188600444","188600446","188600447",
            "188600448","188600449","188600451","188600452","188600453",
            "188600454","188600455","188600456","188600458","188600460",
            "188600461","188600462","188600463","188600464","188600465",
            "188600466","188600467","188600468","188600469","188600471",
            "188600472","188600473","188600474","188600475","188600476",
            "188600477","188600478","188600479","188600480","188600481",
            "188600483","188600484","188600485","188600486","188600487",
            "188600488","188600489","188600490","188600491","188600492",
            "188600493","188600494","188600495","188600496","188600504",
            "188600505","188600516","188600536","188600539","188600540"
        ];
        
        const lotNames = {
            "188600535":"水上舊公所",
            "188600531":"寶雅海佃二",
            "188600343": "家福敦北",
            "188600416": "新店加氣站",
            "188600417": "家福新店安康",
            "188600418": "寶雅樂華",
            "188600419": "土城金城",
            "188600420": "土城峰廷",
            "188600421": "汐止明峰家福",
            "188600422": "格致家福",
            "188600423": "華齡家福",
            "188600424": "北投公館家福",
            "188600425": "寶雅楠梓藍田",
            "188600426": "燦坤海佃",
            "188600427": "寶雅德華",
            "188600428": "土銀敦和(航港局)",
            "188600429": "林口文化北全聯",
            "188600431": "燦坤經國",
            "188600432": "新埔燦坤",
            "188600433": "藏壽司思源",
            "188600434": "藏壽司捷運路",
            "188600435": "藏壽司集賢路",
            "188600436": "藏壽司竹北",
            "188600437": "竹北三民",
            "188600438": "楊梅農會",
            "188600439": "藏壽司青埔",
            "188600440": "寶雅健康2",
            "188600442": "寶雅美妝文心南",
            "188600443": "博愛大樓",
            "188600444": "家福岡山",
            "188600446": "台灣大道",
            "188600447": "花蓮民權",
            "188600448": "台北南海",
            "188600449": "台南轉運站-汽車",
            "188600451": "藏壽司員林",
            "188600452": "台北內湖",
            "188600453": "台中美村南",
            "188600454": "燦坤內埔",
            "188600455": "寶家潮州",
            "188600456": "家福豐南",
            "188600458": "燦坤永華",
            "188600460": "喜互惠羅莊",
            "188600461": "喜互惠文化",
            "188600462": "喜互惠慈安",
            "188600463": "寶雅內壢",
            "188600464": "雀客花蓮",
            "188600465": "寶雅鳳山五福",
            "188600466": "嘉義新民2",
            "188600467": "迪卡儂",
            "188600468": "喜互惠頭城",
            "188600469": "喜互惠和平",
            "188600471": "藏壽司中清",
            "188600472": "藏壽司福科",
            "188600473": "藏壽司惠文",
            "188600474": "藏壽司沙鹿",
            "188600475": "藏壽司嘉義",
            "188600476": "藏壽司頭份",
            "188600477": "藏壽司開元",
            "188600478": "藏壽司楠梓藍田",
            "188600479": "淡水新民",
            "188600480": "林口仁愛二場",
            "188600481": "燦坤彰化",
            "188600483": "北斗中山場",
            "188600484": "新店北新場",
            "188600485": "蘆洲中山場",
            "188600486": "燦坤光復場",
            "188600487": "燦坤瑞隆",
            "188600488": "員林國宅場",
            "188600489": "燦坤彰化場",
            "188600490": "景平天空",
            "188600491": "牛埔東",
            "188600492": "燦坤南崁",
            "188600493": "台中大里",
            "188600494": "家福龍安",
            "188600495": "家福自由",
            "188600496": "家福重和",
            "188600504": "寶雅惠民",
            "188600505": "高雄博愛",
            "188600516": "燦坤豐樂",
            "188600536": "水上中興",
            "188600539": "淡水中山場",
            "188600540": "台南郡平場"
        };
        
        // 車輛查詢系統核心對象
        const CarQuerySystem = {
            // 配置
            config: {
                baseUrl: 'https://gpark.keytop.cn/nkc/carInOut/findCarInOutPage',
                token: FIXED_TOKEN,
                pageSize: PAGE_SIZE,
                appId: '16bbf366b49a48fab362b7f163d96c63',
                opSource: '3000',
                clientFlag: 'PC',
                acceptLanguage: 'zh-TW'
            },
            
            // 狀態
            state: {
                isQueryRunning: false,
                queryStartTime: null,
                currentResults: [],
                queryProgress: 0,
                totalLots: lotCodes.length,
                completedLots: 0,
                totalPlates: 0,
                completedPlates: 0,
                totalRecords: 0,
                currentLotIndex: 0,
                currentPlateIndex: 0,
                queryController: null,
                lotStatus: {} // 儲存每個車廠的查詢狀態
            },
            
            // 初始化
            init() {
                this.updateTotalLots();
                this.setupEventListeners();
                this.initializeLotStatus();
                console.log('全車廠車輛查詢系統已初始化');
                console.log(`固定Token: ${this.config.token.substring(0, 20)}...`);
                console.log(`每頁記錄數: ${this.config.pageSize}`);
                console.log(`總車廠數: ${this.state.totalLots}`);
            },
            
            // 初始化車廠狀態
            initializeLotStatus() {
                lotCodes.forEach(lotCode => {
                    this.state.lotStatus[lotCode] = {
                        name: lotNames[lotCode] || lotCode,
                        status: 'pending', // pending, processing, completed, error
                        records: 0,
                        error: null
                    };
                });
            },
            
            // 更新總車廠數顯示
            updateTotalLots() {
                document.getElementById('total-lots').textContent = this.state.totalLots;
                document.getElementById('total-lots-count').textContent = this.state.totalLots;
            },
            
            // 設置事件監聽器
            setupEventListeners() {
                // 查詢相關
                document.getElementById('search-btn').addEventListener('click', () => this.startAllLotsQuery());
                
                // 導出相關
                document.getElementById('export-json-btn').addEventListener('click', () => this.exportData('json'));
                document.getElementById('export-csv-btn').addEventListener('click', () => this.exportData('csv'));
                document.getElementById('export-excel-btn').addEventListener('click', () => this.exportData('excel'));
                
                // 清除結果
                document.getElementById('clear-results-btn').addEventListener('click', () => this.clearResults());
            },
            
            // 開始全車廠查詢
            async startAllLotsQuery() {
                // 驗證車牌
                const plateInput = document.getElementById('plate-input').value.trim();
                if (!plateInput) {
                    this.showAlert('請輸入至少一個車牌號碼', 'danger');
                    return;
                }
                
                // 解析車牌
                const plates = this.parsePlates(plateInput);
                if (plates.length === 0) {
                    this.showAlert('未找到有效的車牌號碼', 'danger');
                    return;
                }
                
                // 驗證時間範圍
                const startMonth = document.getElementById('year-month-start').value;
                const endMonth = document.getElementById('year-month-end').value;
                
                if (!startMonth || !endMonth) {
                    this.showAlert('請選擇查詢的起始和結束年月', 'danger');
                    return;
                }
                
                if (startMonth > endMonth) {
                    this.showAlert('起始年月不能晚於結束年月', 'danger');
                    return;
                }
                
                // 準備查詢
                this.state.isQueryRunning = true;
                this.state.queryStartTime = new Date();
                this.state.currentResults = [];
                this.state.totalPlates = plates.length;
                this.state.completedPlates = 0;
                this.state.completedLots = 0;
                this.state.totalRecords = 0;
                this.state.queryProgress = 0;
                this.state.currentLotIndex = 0;
                this.state.currentPlateIndex = 0;
                
                // 初始化車廠狀態
                this.initializeLotStatus();
                
                // 創建AbortController以便取消查詢
                if (this.state.queryController) {
                    this.state.queryController.abort();
                }
                this.state.queryController = new AbortController();
                
                // 更新UI
                this.updateProgressStatus('全車廠查詢中...', 0);
                document.getElementById('search-btn').innerHTML = '<i class="fas fa-stop"></i> 停止查詢';
                document.getElementById('search-btn').classList.remove('btn-primary');
                document.getElementById('search-btn').classList.add('btn-danger');
                document.getElementById('current-lot-info').style.display = 'flex';
                
                // 顯示查詢摘要
                this.showSearchSummary(plates, startMonth, endMonth);
                
                // 隱藏無結果提示
                document.getElementById('no-results').style.display = 'none';
                document.getElementById('results-table').style.display = 'block';
                document.getElementById('lot-progress-container').style.display = 'block';
                
                // 清空表格
                document.getElementById('records-body').innerHTML = '';
                
                // 更新車廠進度列表
                this.updateLotProgressList();
                
                // 開始查詢每個車牌在所有車廠
                try {
                    // 對於每個車牌，遍歷所有車廠
                    for (let plateIndex = 0; plateIndex < plates.length; plateIndex++) {
                        if (!this.state.isQueryRunning) break;
                        
                        const plate = plates[plateIndex];
                        this.state.currentPlateIndex = plateIndex;
                        
                        // 更新當前查詢的車牌顯示
                        this.updateActivePlates(plate, plateIndex);
                        
                        // 查詢當前車牌在所有車廠
                        await this.queryPlateInAllLots(plate, startMonth, endMonth, plateIndex, plates.length);
                        
                        // 更新車牌進度
                        this.state.completedPlates++;
                        const plateProgress = Math.round((this.state.completedPlates / this.state.totalPlates) * 100);
                        this.updateProgressStatus(`查詢車牌 ${plate} 完成`, plateProgress);
                    }
                    
                    // 查詢完成
                    this.queryComplete();
                    
                } catch (error) {
                    console.error('全車廠查詢過程中發生錯誤:', error);
                    this.showAlert(`查詢過程中發生錯誤: ${error.message}`, 'danger');
                    this.stopQuery();
                }
            },
            
            // 查詢單個車牌在所有車廠
            async queryPlateInAllLots(plate, startMonth, endMonth, plateIndex, totalPlates) {
                console.log(`開始查詢車牌 ${plate} 在所有車廠`);
                
                // 遍歷所有車廠
                for (let lotIndex = 0; lotIndex < lotCodes.length; lotIndex++) {
                    if (!this.state.isQueryRunning) break;
                    
                    const lotCode = lotCodes[lotIndex];
                    const lotName = lotNames[lotCode] || lotCode;
                    this.state.currentLotIndex = lotIndex;
                    
                    // 更新車廠狀態
                    this.state.lotStatus[lotCode].status = 'processing';
                    this.updateLotProgressItem(lotCode);
                    
                    // 更新當前車廠信息顯示
                    this.updateCurrentLotInfo(lotName, lotCode, `車牌 ${plateIndex + 1}/${totalPlates}`);
                    
                    // 查詢當前車牌在當前車廠
                    await this.queryPlateInLot(plate, lotCode, lotName, startMonth, endMonth);
                    
                    // 更新車廠狀態
                    this.state.lotStatus[lotCode].status = 'completed';
                    this.state.completedLots++;
                    this.updateLotProgressItem(lotCode);
                    
                    // 更新總體進度
                    const totalTasks = lotCodes.length * this.state.totalPlates;
                    const completedTasks = (plateIndex * lotCodes.length) + (lotIndex + 1);
                    const overallProgress = Math.round((completedTasks / totalTasks) * 100);
                    
                    this.updateProgressStatus(
                        `查詢車牌 ${plate} (${plateIndex + 1}/${this.state.totalPlates}) - 車廠 ${lotName} (${lotIndex + 1}/${lotCodes.length})`,
                        overallProgress
                    );
                    
                    // 車廠間延遲（避免請求過快）
                    if (lotIndex < lotCodes.length - 1 && this.state.isQueryRunning) {
                        await this.delay(500);
                    }
                }
            },
            
            // 查詢單個車牌在單個車廠
            async queryPlateInLot(plate, lotCode, lotName, startMonth, endMonth) {
                // 構建時間範圍
                const startDate = `${startMonth}-01 00:00:00`;
                const endDate = this.getLastDayOfMonth(endMonth);
                
                let pageNum = 1;
                let hasMorePages = true;
                let lotRecords = 0;
                
                while (hasMorePages && this.state.isQueryRunning) {
                    try {
                        const result = await this.fetchPage(plate, lotCode, startDate, endDate, pageNum);
                        
                        if (result.success) {
                            // 處理返回的數據
                            const records = result.data?.vos || [];
                            const recordsCount = records.length;
                            lotRecords += recordsCount;
                            this.state.totalRecords += recordsCount;
                            this.state.lotStatus[lotCode].records += recordsCount;
                            
                            // 添加到結果集
                            this.state.currentResults.push(...records.map(record => ({
                                ...record,
                                plate, // 添加車牌字段
                                lotCode,
                                lotName
                            })));
                            
                            // 更新表格
                            this.updateResultsTable(records, plate, lotName);
                            
                            // 更新記錄數顯示
                            document.getElementById('total-records').textContent = this.state.totalRecords;
                            document.getElementById('progress-records').textContent = this.state.totalRecords;
                            document.getElementById('summary-records').textContent = this.state.totalRecords;
                            
                            // 計算是否還有更多頁
                            const total = result.data?.total || 0;
                            const totalPages = Math.ceil(total / this.config.pageSize);
                            hasMorePages = pageNum < totalPages;
                            pageNum++;
                            
                            // 更新當前車廠進度顯示
                            const currentProgress = totalPages > 0 
                                ? `第 ${pageNum - 1}/${totalPages} 頁` 
                                : `第 ${pageNum - 1} 頁`;
                            this.updateCurrentLotInfo(lotName, lotCode, currentProgress);
                            
                            // 頁間延遲
                            await this.delay(300);
                            
                        } else {
                            // 處理錯誤
                            if (result.code === 406 || result.code === 401) {
                                this.state.lotStatus[lotCode].status = 'error';
                                this.state.lotStatus[lotCode].error = 'Token無效或已過期';
                                this.updateLotProgressItem(lotCode);
                                throw new Error(`Token無效或已過期 (車廠: ${lotName})`);
                            } else {
                                console.warn(`查詢車牌 ${plate} 在車廠 ${lotName} 第 ${pageNum} 頁失敗: ${result.message}`);
                                // 標記錯誤但繼續
                                this.state.lotStatus[lotCode].status = 'error';
                                this.state.lotStatus[lotCode].error = result.message;
                                this.updateLotProgressItem(lotCode);
                                break;
                            }
                        }
                        
                    } catch (error) {
                        console.error(`查詢車牌 ${plate} 在車廠 ${lotName} 時發生錯誤:`, error);
                        
                        // 如果是網絡錯誤，標記錯誤並繼續下一個車廠
                        if (error.name === 'AbortError') {
                            console.log('查詢被用戶取消');
                            throw error;
                        }
                        
                        this.state.lotStatus[lotCode].status = 'error';
                        this.state.lotStatus[lotCode].error = error.message;
                        this.updateLotProgressItem(lotCode);
                        break;
                    }
                }
                
                console.log(`完成查詢車牌 ${plate} 在車廠 ${lotName}, 獲取 ${lotRecords} 條記錄`);
                return lotRecords;
            },
            
            // 解析車牌輸入
            parsePlates(input) {
                // 支持逗號分隔、換行分隔或空格分隔
                return input
                    .split(/[,;\n\s]+/)
                    .map(plate => plate.trim().toUpperCase())
                    .filter(plate => plate.length > 0);
            },
            
            // 獲取單頁數據
            async fetchPage(plate, lotCode, startDate, endDate, pageNum) {
                const payload = {
                    lotCode: lotCode,
                    carTimeStart: startDate,
                    carTimeEnd: endDate,
                    carNo: plate, // 完全匹配
                    currentPage: pageNum,
                    pageSize: this.config.pageSize,
                    emptyPlate: "0",
                    carNoType: "0",
                    totalCount: 0
                };
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json, text/plain, */*',
                    'kt-token': this.config.token,
                    'kt-appId': this.config.appId,
                    'kt-lotcodes': lotCode,
                    'op-source': this.config.opSource,
                    'client-flag': this.config.clientFlag,
                    'accept-language': this.config.acceptLanguage
                };
                
                try {
                    const response = await fetch(this.config.baseUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload),
                        signal: this.state.queryController?.signal,
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    return {
                        success: data.resultCode === 200,
                        data: data.data,
                        code: data.resultCode,
                        message: data.resultMsg
                    };
                    
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            },
            
            // 獲取月份的最後一天
            getLastDayOfMonth(monthStr) {
                const [year, month] = monthStr.split('-').map(Number);
                const lastDay = new Date(year, month, 0).getDate(); // 月份為0表示上個月最後一天
                return `${monthStr}-${lastDay.toString().padStart(2, '0')} 23:59:59`;
            },
            
            // 更新結果表格
            updateResultsTable(records, plate, lotName) {
                const tbody = document.getElementById('records-body');
                
                records.forEach(record => {
                    const row = document.createElement('tr');
                    
                    // 判斷進出方向
                    const directionClass = record.nodeName === '入口' ? 'record-in' : 'record-out';
                    const directionIcon = record.nodeName === '入口' ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
                    
                    row.innerHTML = `
                        <td><strong>${plate}</strong></td>
                        <td class="${directionClass}"><i class="fas ${directionIcon}"></i> ${record.nodeName || ''}</td>
                        <td class="record-time">${record.carTime || ''}</td>
                        <td>${record.carType || ''}</td>
                        <td>${record.releaseType || ''}</td>
                        <td>${record.nodeId || ''}</td>
                        <td>${lotName}</td>
                        <td>${record.remark || ''}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            },
            
            // 顯示查詢摘要
            showSearchSummary(plates, startMonth, endMonth) {
                const summaryElement = document.getElementById('search-summary');
                const summaryText = document.getElementById('summary-text');
                const activePlates = document.getElementById('active-plates');
                
                summaryElement.style.display = 'flex';
                summaryText.textContent = `查詢 ${plates.length} 個車牌，時間範圍: ${startMonth} 至 ${endMonth}，遍歷 ${this.state.totalLots} 個車廠`;
                
                // 更新摘要卡片
                document.getElementById('summary-plates').textContent = plates.length;
                document.getElementById('summary-lots').textContent = this.state.completedLots;
                document.getElementById('summary-records').textContent = this.state.totalRecords;
                
                // 顯示所有要查詢的車牌
                activePlates.innerHTML = plates.map(plate => 
                    `<span class="plate-badge">${plate}</span>`
                ).join('');
            },
            
            // 更新當前活動的車牌顯示
            updateActivePlates(currentPlate, currentIndex) {
                const allPlates = document.querySelectorAll('.plate-badge');
                
                // 移除所有高亮
                allPlates.forEach(badge => {
                    badge.classList.remove('active-plate');
                });
                
                // 高亮當前查詢的車牌
                if (allPlates[currentIndex]) {
                    allPlates[currentIndex].classList.add('active-plate');
                }
            },
            
            // 更新當前車廠信息
            updateCurrentLotInfo(lotName, lotCode, progress) {
                document.getElementById('current-lot-name').textContent = lotName;
                document.getElementById('current-lot-id').textContent = lotCode;
                document.getElementById('current-lot-progress').textContent = progress;
            },
            
            // 更新車廠進度列表
            updateLotProgressList() {
                const container = document.getElementById('lot-progress-list');
                container.innerHTML = '';
                
                lotCodes.forEach(lotCode => {
                    const lotInfo = this.state.lotStatus[lotCode];
                    const statusClass = `lot-status-${lotInfo.status}`;
                    const statusText = {
                        'pending': '等待中',
                        'processing': '查詢中',
                        'completed': '完成',
                        'error': '錯誤'
                    }[lotInfo.status] || lotInfo.status;
                    
                    const item = document.createElement('div');
                    item.className = 'lot-progress-item';
                    item.innerHTML = `
                        <span class="lot-name">${lotInfo.name}</span>
                        <span class="lot-status ${statusClass}">
                            ${statusText}${lotInfo.records > 0 ? ` (${lotInfo.records}筆)` : ''}
                            ${lotInfo.error ? ` - ${lotInfo.error}` : ''}
                        </span>
                    `;
                    container.appendChild(item);
                });
            },
            
            // 更新單個車廠進度項目
            updateLotProgressItem(lotCode) {
                const lotInfo = this.state.lotStatus[lotCode];
                const items = document.querySelectorAll('.lot-progress-item');
                
                items.forEach(item => {
                    const lotNameElement = item.querySelector('.lot-name');
                    if (lotNameElement && lotNameElement.textContent === lotInfo.name) {
                        const statusClass = `lot-status-${lotInfo.status}`;
                        const statusText = {
                            'pending': '等待中',
                            'processing': '查詢中',
                            'completed': '完成',
                            'error': '錯誤'
                        }[lotInfo.status] || lotInfo.status;
                        
                        const statusElement = item.querySelector('.lot-status');
                        statusElement.className = `lot-status ${statusClass}`;
                        statusElement.textContent = `${statusText}${lotInfo.records > 0 ? ` (${lotInfo.records}筆)` : ''}${lotInfo.error ? ` - ${lotInfo.error}` : ''}`;
                    }
                });
            },
            
            // 更新進度狀態
            updateProgressStatus(status, progress) {
                // 更新進度條
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressStatus = document.getElementById('progress-status');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
                
                if (progressStatus) {
                    progressStatus.textContent = status;
                }
                
                // 更新已處理車廠數
                document.getElementById('lots-processed').textContent = this.state.completedLots;
                document.getElementById('summary-lots').textContent = this.state.completedLots;
                
                // 更新查詢時間
                if (this.state.queryStartTime) {
                    const elapsed = Math.floor((new Date() - this.state.queryStartTime) / 1000);
                    document.getElementById('progress-time').textContent = `${elapsed}秒`;
                    document.getElementById('total-time').textContent = `${elapsed}秒`;
                    document.getElementById('summary-time').textContent = `${elapsed}s`;
                }
            },
            
            // 查詢完成
            queryComplete() {
                this.state.isQueryRunning = false;
                
                // 更新按鈕狀態
                document.getElementById('search-btn').innerHTML = '<i class="fas fa-search"></i> 開始全車廠查詢';
                document.getElementById('search-btn').classList.remove('btn-danger');
                document.getElementById('search-btn').classList.add('btn-primary');
                
                // 更新狀態
                const status = this.state.queryController?.signal.aborted ? '已停止' : '完成';
                this.updateProgressStatus(status, this.state.queryProgress);
                
                // 隱藏當前車廠信息
                document.getElementById('current-lot-info').style.display = 'none';
                
                // 顯示完成消息
                if (this.state.totalRecords > 0) {
                    this.showAlert(`全車廠查詢完成！共獲取 ${this.state.totalRecords} 條記錄`, 'success');
                } else {
                    this.showAlert('查詢完成，但未找到匹配的記錄', 'warning');
                }
                
                // 更新摘要
                document.getElementById('summary-records').textContent = this.state.totalRecords;
            },
            
            // 停止查詢
            stopQuery() {
                this.state.isQueryRunning = false;
                if (this.state.queryController) {
                    this.state.queryController.abort();
                }
                this.queryComplete();
            },
            
            // 導出數據
            exportData(format) {
                if (this.state.currentResults.length === 0) {
                    this.showAlert('沒有數據可導出', 'warning');
                    return;
                }
                
                let dataStr, mimeType, filename;
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const plates = Array.from(new Set(this.state.currentResults.map(r => r.plate))).join('_');
                
                if (format === 'json') {
                    dataStr = JSON.stringify(this.state.currentResults, null, 2);
                    mimeType = 'application/json';
                    filename = `全車廠車輛記錄_${plates}_${timestamp}.json`;
                } else if (format === 'csv') {
                    // 創建CSV內容
                    const headers = ['車牌', '方向', '時間', '車輛類型', '放行類型', '通道', '車廠', '車廠ID', '備註'];
                    const rows = this.state.currentResults.map(record => [
                        record.plate || record.carNo,
                        record.nodeName,
                        record.carTime,
                        record.carType,
                        record.releaseType,
                        record.nodeId,
                        record.lotName,
                        record.lotCode,
                        record.remark || ''
                    ]);
                    
                    // 轉義CSV中的特殊字符
                    const escapeCsv = (cell) => {
                        if (cell === null || cell === undefined) return '';
                        const str = String(cell);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };
                    
                    const csvContent = [
                        headers.join(','),
                        ...rows.map(row => row.map(escapeCsv).join(','))
                    ].join('\n');
                    
                    dataStr = '\uFEFF' + csvContent; // BOM for Excel
                    mimeType = 'text/csv;charset=utf-8;';
                    filename = `全車廠車輛記錄_${plates}_${timestamp}.csv`;
                } else if (format === 'excel') {
                    // 實際上還是CSV，但用.xls擴展名讓Excel更容易識別
                    const headers = ['車牌', '方向', '時間', '車輛類型', '放行類型', '通道', '車廠', '車廠ID', '備註'];
                    const rows = this.state.currentResults.map(record => [
                        record.plate || record.carNo,
                        record.nodeName,
                        record.carTime,
                        record.carType,
                        record.releaseType,
                        record.nodeId,
                        record.lotName,
                        record.lotCode,
                        record.remark || ''
                    ]);
                    
                    const escapeCsv = (cell) => {
                        if (cell === null || cell === undefined) return '';
                        const str = String(cell);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };
                    
                    const csvContent = [
                        headers.join(','),
                        ...rows.map(row => row.map(escapeCsv).join(','))
                    ].join('\n');
                    
                    dataStr = '\uFEFF' + csvContent;
                    mimeType = 'application/vnd.ms-excel';
                    filename = `全車廠車輛記錄_${plates}_${timestamp}.xls`;
                }
                
                // 創建下載鏈接
                const blob = new Blob([dataStr], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                this.showAlert(`數據已導出為 ${filename}`, 'success');
            },
            
            // 清除結果
            clearResults() {
                if (this.state.isQueryRunning) {
                    if (!confirm('查詢正在進行中，確定要清除結果嗎？')) {
                        return;
                    }
                    this.stopQuery();
                }
                
                this.state.currentResults = [];
                document.getElementById('records-body').innerHTML = '';
                document.getElementById('no-results').style.display = 'block';
                document.getElementById('results-table').style.display = 'none';
                document.getElementById('search-summary').style.display = 'none';
                document.getElementById('lot-progress-container').style.display = 'none';
                document.getElementById('current-lot-info').style.display = 'none';
                
                // 重置狀態顯示
                document.getElementById('total-records').textContent = '0';
                document.getElementById('progress-records').textContent = '0';
                document.getElementById('progress-time').textContent = '0秒';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text').textContent = '0%';
                document.getElementById('progress-status').textContent = '就緒';
                document.getElementById('lots-processed').textContent = '0';
                document.getElementById('total-time').textContent = '0秒';
                
                // 重置摘要
                document.getElementById('summary-lots').textContent = '0';
                document.getElementById('summary-plates').textContent = '0';
                document.getElementById('summary-records').textContent = '0';
                document.getElementById('summary-time').textContent = '0s';
                
                this.showAlert('查詢結果已清除', 'info');
            },
            
            // 顯示提示消息
            showAlert(message, type) {
                const alertArea = document.getElementById('alert-area');
                const alertId = `alert-${Date.now()}`;
                
                const alert = document.createElement('div');
                alert.id = alertId;
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                    <div>${message}</div>
                    <button class="alert-close" style="margin-left: auto; background: none; border: none; color: inherit; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // 添加關閉按鈕事件
                alert.querySelector('.alert-close').addEventListener('click', () => {
                    alert.remove();
                });
                
                alertArea.appendChild(alert);
                
                // 5秒後自動消失（除了錯誤類型）
                if (type !== 'danger') {
                    setTimeout(() => {
                        const alertElement = document.getElementById(alertId);
                        if (alertElement) {
                            alertElement.remove();
                        }
                    }, 5000);
                }
            },
            
            // 延遲函數
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };
        
        // 頁面加載完成後初始化系統
        document.addEventListener('DOMContentLoaded', () => {
            CarQuerySystem.init();
            
            // 設置範例數據
            document.getElementById('plate-input').value = '7831S2\nCBC0192';
            
            // 設置當前日期為結束月份
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('year-month-end').value = `${currentYear}-${currentMonth}`;
        });
        
        // 添加鍵盤快捷鍵
        document.addEventListener('keydown', (e) => {
            // Ctrl+Enter 開始查詢
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('search-btn').click();
            }
            
            // Esc 停止查詢
            if (e.key === 'Escape' && CarQuerySystem.state.isQueryRunning) {
                CarQuerySystem.stopQuery();
            }
        });
    </script>
</body>
</html>
