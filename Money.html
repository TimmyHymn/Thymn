<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœè»Šå ´æ”¶å…¥åˆ†æå„€è¡¨æ¿ - å®Œæ•´åˆ†æ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a6dcc 0%, #0d4d9c 100%);
            color: white;
            padding: 25px 0;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .current-time {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #1a6dcc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #0d4d9c;
        }
        
        .btn-refresh {
            background-color: #10a54a;
        }
        
        .btn-refresh:hover {
            background-color: #0c8a3d;
        }
        
        .btn-export {
            background-color: #6c757d;
        }
        
        .btn-export:hover {
            background-color: #5a6268;
        }
        
        .btn-comparison {
            background-color: #9c27b0;
        }
        
        .btn-comparison:hover {
            background-color: #7b1fa2;
        }
        
        .search-box {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .card-trend {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up {
            color: #10a54a;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .data-table {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .table-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background-color: #f1f5f9;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background-color: #e2e8f0;
        }
        
        th.sorted-asc::after {
            content: " â†‘";
            font-weight: bold;
            color: #1a6dcc;
        }
        
        th.sorted-desc::after {
            content: " â†“";
            font-weight: bold;
            color: #1a6dcc;
        }
        
        td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        tbody tr.selected {
            background-color: #e8f4ff;
        }
        
        .lot-name {
            font-weight: 600;
            color: #1a6dcc;
        }
        
        .amount {
            font-weight: 600;
            color: #212529;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #10a54a;
        }
        
        .status-inactive {
            background-color: #dc3545;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-container, .details-container, .comparison-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title, .details-title, .comparison-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chart {
            height: 250px;
            display: flex;
            align-items: flex-end;
            gap: 5px;
            padding-top: 20px;
        }
        
        .bar {
            flex: 1;
            background-color: #1a6dcc;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s;
        }
        
        .bar:hover {
            background-color: #0d4d9c;
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #6c757d;
        }
        
        .details-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .details-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .details-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .details-value {
            font-size: 18px;
            font-weight: 600;
        }
        
        .comparison-content {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comparison-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .comparison-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .comparison-label {
            font-size: 14px;
            color: #495057;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .comparison-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a6dcc;
        }
        
        .comparison-subvalue {
            font-size: 13px;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .positive {
            color: #10a54a;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .daily-details {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .daily-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }
        
        .daily-item:last-child {
            border-bottom: none;
        }
        
        .daily-date {
            color: #495057;
            flex: 1;
        }
        
        .daily-amount {
            font-weight: 500;
            color: #212529;
            text-align: right;
            flex: 1;
        }
        
        .daily-total {
            font-weight: 600;
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #1a6dcc;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .page-btn {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .page-btn.active {
            background-color: #1a6dcc;
            color: white;
            border-color: #1a6dcc;
        }
        
        .page-btn:hover:not(.active) {
            background-color: #f8f9fa;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 14px;
            margin-top: 30px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-box {
                margin: 0;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1><i class="fas fa-chart-line"></i> åœè»Šå ´æ”¶å…¥åˆ†æå„€è¡¨æ¿</h1>
                    <p class="subtitle">ç•¶æœˆç´¯è¨ˆ + 365å¤©æ¯”è¼ƒåˆ†æ</p>
                </div>
                <div class="current-time" id="currentTime">è¼‰å…¥æ™‚é–“: ...</div>
            </div>
        </header>
        
        <div class="controls">
            <button class="btn" id="analyzeBtn">
                <i class="fas fa-play-circle"></i> åŸ·è¡Œå®Œæ•´åˆ†æ
            </button>
            
            <button class="btn btn-comparison" id="comparisonBtn">
                <i class="fas fa-chart-bar"></i> é¡¯ç¤ºæ¯”è¼ƒåˆ†æ
            </button>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="æœå°‹åœè»Šå ´ç·¨è™Ÿæˆ–åç¨±...">
            </div>
            
            <button class="btn btn-refresh" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
            </button>
            
            <button class="btn btn-export" id="exportBtn">
                <i class="fas fa-file-export"></i> åŒ¯å‡ºå ±è¡¨
            </button>
        </div>
        
        <div class="summary-cards">
            <div class="card">
                <div class="card-title">ç¸½åœè»Šå ´æ•¸</div>
                <div class="card-value" id="totalParkingCount">80</div>
                <div class="card-trend">
                    <i class="fas fa-building"></i> å…¨éƒ¨ç«™é»
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">æœ¬æœˆç¸½æ”¶å…¥</div>
                <div class="card-value" id="totalMonthIncome">NT$0</div>
                <div class="card-trend">
                    <i class="fas fa-calendar-alt"></i> ç•¶æœˆç´¯è¨ˆ
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">æœ€é«˜æ”¶å…¥å ´ç«™</div>
                <div class="card-value" id="topIncomeLot">-</div>
                <div class="card-trend">
                    <i class="fas fa-crown"></i> æœ¬æœˆå† è»
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">å¹³å‡æ”¶å…¥/å ´</div>
                <div class="card-value" id="avgIncome">NT$0</div>
                <div class="card-trend">
                    <i class="fas fa-chart-bar"></i> å ´ç«™å¹³å‡
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">ç•¶æœˆæœ€æ–°ç´¯è¨ˆæ”¶å…¥æ˜ç´°</div>
                    <div>é¡¯ç¤º <span id="shownCount">0</span> / <span id="totalCount">80</span> å€‹å ´ç«™</div>
                </div>
                
                <div id="loadingArea" class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>è¼‰å…¥åœè»Šå ´æ”¶å…¥æ•¸æ“šä¸­...</p>
                </div>
                
                <div id="tableArea" style="display: none;">
                    <div class="table-container">
                        <table id="incomeTable">
                            <thead>
                                <tr>
                                    <th width="30"></th>
                                    <th width="120" data-sort="lotCode">å ´ç«™ç·¨è™Ÿ <span class="sort-icon"></span></th>
                                    <th data-sort="lotName">å ´ç«™åç¨± <span class="sort-icon"></span></th>
                                    <th width="150" data-sort="monthIncome">æœ¬æœˆç´¯è¨ˆæ”¶å…¥ <span class="sort-icon"></span></th>
                                    <th width="120" data-sort="incomeRecords">æ”¶å…¥ç­†æ•¸ <span class="sort-icon"></span></th>
                                    <th width="120" data-sort="daysWithIncome">æœ‰æ”¶å…¥å¤©æ•¸ <span class="sort-icon"></span></th>
                                    <th width="150" data-sort="avgPerDay">æ—¥å‡æ”¶å…¥ <span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- æ•¸æ“šå°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination">
                        <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                        <span id="pageNumbers"></span>
                        <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div id="noDataArea" class="no-data" style="display: none;">
                    <i class="fas fa-database"></i>
                    <p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„åœè»Šå ´æ•¸æ“š</p>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="chart-container">
                    <div class="chart-title">æ”¶å…¥åˆ†ä½ˆåœ– (å‰10å)</div>
                    <div class="chart" id="incomeChart">
                        <!-- åœ–è¡¨å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="details-container">
                    <div class="details-title">é¸ä¸­å ´ç«™è©³ç´°è³‡è¨Š</div>
                    <div id="detailsContent">
                        <div class="details-item">
                            <div class="details-label">å ´ç«™ç·¨è™Ÿ</div>
                            <div class="details-value" id="detailLotCode">-</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">å ´ç«™åç¨±</div>
                            <div class="details-value" id="detailLotName">-</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">æœ¬æœˆç´¯è¨ˆæ”¶å…¥</div>
                            <div class="details-value" id="detailMonthIncome">NT$0</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">æ”¶å…¥ç­†æ•¸</div>
                            <div class="details-value" id="detailIncomeRecords">0 ç­†</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">æœ‰æ”¶å…¥å¤©æ•¸</div>
                            <div class="details-value" id="detailDaysWithIncome">0 å¤©</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">æ—¥å‡æ”¶å…¥</div>
                            <div class="details-value" id="detailAvgPerDay">NT$0</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">ç­†å‡æ”¶å…¥</div>
                            <div class="details-value" id="detailAvgPerRecord">NT$0</div>
                        </div>
                        <div id="dailyDetails" class="daily-details" style="display: none;">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 10px;">æ¯æ—¥æ”¶å…¥æ˜ç´°</div>
                            <div id="dailyDetailsContent">
                                <!-- æ¯æ—¥æ˜ç´°å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="comparison-container" id="comparisonContainer" style="display: none;">
                    <div class="comparison-title">
                        <i class="fas fa-balance-scale"></i> æ¯”è¼ƒåˆ†æ
                    </div>
                    <div class="comparison-content" id="comparisonContent">
                        <!-- æ¯”è¼ƒåˆ†ææ•¸æ“šå°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Timmy åœè»Šå ´æ”¶å…¥åˆ†æç³»çµ± | æ•¸æ“šä¾†æº: åœè»Šå ´ç®¡ç†ç³»çµ± | æœ€å¾Œæ›´æ–°: <span id="lastUpdateTime">-</span></p>
        </footer>
    </div>

    <script>
        // åœè»Šå ´æ•¸æ“š
        const token = "ilbnrfsjr6a0fnq20wyz50dtrqp3jah5zohmw8cxmquyubek4cc2wmsqaj0hi41hy5yru50eo4";
        
        const lotCodes = [
            "188600343","188600416","188600417","188600418","188600419",
            "188600420","188600421","188600422","188600423","188600424",
            "188600425","188600426","188600427","188600428","188600429",
            "188600431","188600432","188600433","188600434","188600435",
            "188600436","188600437","188600438","188600439","188600440",
            "188600442","188600443","188600444","188600446","188600447",
            "188600448","188600449","188600451","188600452","188600453",
            "188600454","188600455","188600456","188600458","188600460",
            "188600461","188600462","188600463","188600464","188600465",
            "188600466","188600467","188600468","188600469","188600471",
            "188600472","188600473","188600474","188600475","188600476",
            "188600477","188600478","188600479","188600480","188600481",
            "188600483","188600484","188600485","188600486","188600487",
            "188600488","188600489","188600490","188600491","188600492",
            "188600493","188600494","188600495","188600496","188600504",
            "188600505","188600516","188600536","188600539","188600540"
        ];
        
        const lotNames = {
            "188600343": "å®¶ç¦æ•¦åŒ—",
            "188600416": "æ–°åº—åŠ æ°£ç«™",
            "188600417": "å®¶ç¦æ–°åº—å®‰åº·",
            "188600418": "å¯¶é›…æ¨‚è¯",
            "188600419": "åœŸåŸé‡‘åŸ",
            "188600420": "åœŸåŸå³°å»·",
            "188600421": "æ±æ­¢æ˜å³°å®¶ç¦",
            "188600422": "æ ¼è‡´å®¶ç¦",
            "188600423": "è¯é½¡å®¶ç¦",
            "188600424": "åŒ—æŠ•å…¬é¤¨å®¶ç¦",
            "188600425": "å¯¶é›…æ¥ æ¢“è—ç”°",
            "188600426": "ç‡¦å¤æµ·ä½ƒ",
            "188600427": "å¯¶é›…å¾·è¯",
            "188600428": "åœŸéŠ€æ•¦å’Œ(èˆªæ¸¯å±€)",
            "188600429": "æ—å£æ–‡åŒ–åŒ—å…¨è¯",
            "188600431": "ç‡¦å¤ç¶“åœ‹",
            "188600432": "æ–°åŸ”ç‡¦å¤",
            "188600433": "è—å£½å¸æ€æº",
            "188600434": "è—å£½å¸æ·é‹è·¯",
            "188600435": "è—å£½å¸é›†è³¢è·¯",
            "188600436": "è—å£½å¸ç«¹åŒ—",
            "188600437": "ç«¹åŒ—ä¸‰æ°‘",
            "188600438": "æ¥Šæ¢…è¾²æœƒ",
            "188600439": "è—å£½å¸é’åŸ”",
            "188600440": "å¯¶é›…å¥åº·2",
            "188600442": "å¯¶é›…ç¾å¦æ–‡å¿ƒå—",
            "188600443": "åšæ„›å¤§æ¨“",
            "188600444": "å®¶ç¦å²¡å±±",
            "188600446": "å°ç£å¤§é“",
            "188600447": "èŠ±è“®æ°‘æ¬Š",
            "188600448": "å°åŒ—å—æµ·",
            "188600449": "å°å—è½‰é‹ç«™-æ±½è»Š",
            "188600451": "è—å£½å¸å“¡æ—",
            "188600452": "å°åŒ—å…§æ¹–",
            "188600453": "å°ä¸­ç¾æ‘å—",
            "188600454": "ç‡¦å¤å…§åŸ”",
            "188600455": "å¯¶å®¶æ½®å·",
            "188600456": "å®¶ç¦è±å—",
            "188600458": "ç‡¦å¤æ°¸è¯",
            "188600460": "å–œäº’æƒ ç¾…èŠ",
            "188600461": "å–œäº’æƒ æ–‡åŒ–",
            "188600462": "å–œäº’æƒ æ…ˆå®‰",
            "188600463": "å¯¶é›…å…§å£¢",
            "188600464": "é›€å®¢èŠ±è“®",
            "188600465": "å¯¶é›…é³³å±±äº”ç¦",
            "188600466": "å˜‰ç¾©æ–°æ°‘2",
            "188600467": "è¿ªå¡å„‚",
            "188600468": "å–œäº’æƒ é ­åŸ",
            "188600469": "å–œäº’æƒ å’Œå¹³",
            "188600471": "è—å£½å¸ä¸­æ¸…",
            "188600472": "è—å£½å¸ç¦ç§‘",
            "188600473": "è—å£½å¸æƒ æ–‡",
            "188600474": "è—å£½å¸æ²™é¹¿",
            "188600475": "è—å£½å¸å˜‰ç¾©",
            "188600476": "è—å£½å¸é ­ä»½",
            "188600477": "è—å£½å¸é–‹å…ƒ",
            "188600478": "è—å£½å¸æ¥ æ¢“è—ç”°",
            "188600479": "æ·¡æ°´æ–°æ°‘",
            "188600480": "æ—å£ä»æ„›äºŒå ´",
            "188600481": "ç‡¦å¤å½°åŒ–",
            "188600483": "åŒ—æ–—ä¸­å±±å ´",
            "188600484": "æ–°åº—åŒ—æ–°å ´",
            "188600485": "è˜†æ´²ä¸­å±±å ´",
            "188600486": "ç‡¦å¤å…‰å¾©å ´",
            "188600487": "ç‡¦å¤ç‘éš†",
            "188600488": "å“¡æ—åœ‹å®…å ´",
            "188600489": "ç‡¦å¤å½°åŒ–å ´",
            "188600490": "æ™¯å¹³å¤©ç©º",
            "188600491": "ç‰›åŸ”æ±",
            "188600492": "ç‡¦å¤å—å´",
            "188600493": "å°ä¸­å¤§é‡Œ",
            "188600494": "å®¶ç¦é¾å®‰",
            "188600495": "å®¶ç¦è‡ªç”±",
            "188600496": "å®¶ç¦é‡å’Œ",
            "188600504": "å¯¶é›…æƒ æ°‘",
            "188600505": "é«˜é›„åšæ„›",
            "188600516": "ç‡¦å¤è±æ¨‚",
            "188600536": "æ°´ä¸Šä¸­èˆˆ",
            "188600539": "æ·¡æ°´ä¸­å±±å ´",
            "188600540": "å°å—éƒ¡å¹³å ´"
        };
        
        // å…¨å±€è®Šé‡
        let allParkingData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 15;
        let selectedLotCode = null;
        let currentSortField = 'monthIncome';
        let currentSortDirection = 'desc';
        let comparisonData = null;
        
        // DOM å…ƒç´ 
        const analyzeBtn = document.getElementById('analyzeBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportBtn = document.getElementById('exportBtn');
        const comparisonBtn = document.getElementById('comparisonBtn');
        const searchInput = document.getElementById('searchInput');
        const loadingArea = document.getElementById('loadingArea');
        const tableArea = document.getElementById('tableArea');
        const noDataArea = document.getElementById('noDataArea');
        const tableBody = document.getElementById('tableBody');
        const totalCount = document.getElementById('totalCount');
        const shownCount = document.getElementById('shownCount');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbers = document.getElementById('pageNumbers');
        const incomeChart = document.getElementById('incomeChart');
        const tableHeaders = document.querySelectorAll('th[data-sort]');
        const comparisonContainer = document.getElementById('comparisonContainer');
        const comparisonContent = document.getElementById('comparisonContent');
        const dailyDetails = document.getElementById('dailyDetails');
        const dailyDetailsContent = document.getElementById('dailyDetailsContent');
        
        // æ‘˜è¦å¡ç‰‡å…ƒç´ 
        const totalMonthIncome = document.getElementById('totalMonthIncome');
        const topIncomeLot = document.getElementById('topIncomeLot');
        const avgIncome = document.getElementById('avgIncome');
        
        // è©³ç´°è³‡è¨Šå…ƒç´ 
        const detailLotCode = document.getElementById('detailLotCode');
        const detailLotName = document.getElementById('detailLotName');
        const detailMonthIncome = document.getElementById('detailMonthIncome');
        const detailIncomeRecords = document.getElementById('detailIncomeRecords');
        const detailDaysWithIncome = document.getElementById('detailDaysWithIncome');
        const detailAvgPerDay = document.getElementById('detailAvgPerDay');
        const detailAvgPerRecord = document.getElementById('detailAvgPerRecord');
        
        // æ™‚é–“å…ƒç´ 
        const currentTime = document.getElementById('currentTime');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // ç¶å®šäº‹ä»¶
            analyzeBtn.addEventListener('click', analyzeAllParkingLots);
            refreshBtn.addEventListener('click', analyzeAllParkingLots);
            comparisonBtn.addEventListener('click', toggleComparison);
            exportBtn.addEventListener('click', exportReport);
            searchInput.addEventListener('input', filterTable);
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            
            // ç¶å®šè¡¨æ ¼æ’åºäº‹ä»¶
            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const sortField = header.dataset.sort;
                    sortTable(sortField);
                });
            });
            
            // é¡¯ç¤ºåˆå§‹æ•¸æ“š
            totalCount.textContent = lotCodes.length;
            
            // åŸ·è¡Œåˆ†æ
            analyzeAllParkingLots();
        });
        
        // æ›´æ–°ç•¶å‰æ™‚é–“
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            currentTime.textContent = `ç•¶å‰æ™‚é–“: ${timeString}`;
        }
        
        // åˆ†ææ‰€æœ‰åœè»Šå ´
        async function analyzeAllParkingLots() {
            loadingArea.style.display = 'block';
            tableArea.style.display = 'none';
            noDataArea.style.display = 'none';
            
            try {
                // ç²å–æ‰€æœ‰åœè»Šå ´çš„å¯¦éš›æ•¸æ“š
                allParkingData = [];
                
                // ä½¿ç”¨Promise.allä¾†ä¸¦è¡Œç²å–æ‰€æœ‰åœè»Šå ´æ•¸æ“š
                const promises = lotCodes.map(lotCode => getParkingData(lotCode));
                const results = await Promise.all(promises);
                
                // éæ¿¾æ‰å¤±æ•—çš„çµæœ
                allParkingData = results.filter(result => result.success);
                
                // æŒ‰ç…§ç•¶å‰æ’åºè¦å‰‡æ’åº
                sortData(currentSortField, currentSortDirection);
                
                // åˆå§‹åŒ–ç¯©é¸æ•¸æ“š
                filteredData = [...allParkingData];
                
                // ç²å–365å¤©æ¯”è¼ƒæ•¸æ“šï¼ˆå¦‚æœå·²é¸ä¸­åœè»Šå ´ï¼‰
                if (selectedLotCode) {
                    comparisonData = await get365DaysData(selectedLotCode);
                }
                
                // æ›´æ–°UI
                updateSummaryCards();
                renderTable();
                if (comparisonData && comparisonContainer.style.display !== 'none') {
                    renderComparison();
                }
                loadingArea.style.display = 'none';
                tableArea.style.display = 'block';
                
                // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
                const now = new Date();
                lastUpdateTime.textContent = now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                console.log(`âœ… æˆåŠŸç²å– ${allParkingData.length} å€‹åœè»Šå ´çš„å¯¦éš›æ•¸æ“š`);
                
            } catch (error) {
                console.error('âŒ ç²å–æ•¸æ“šå¤±æ•—:', error);
                loadingArea.style.display = 'none';
                noDataArea.style.display = 'block';
                noDataArea.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>æ•¸æ“šç²å–å¤±æ•—: ${error.message}</p>
                    <p style="margin-top: 10px; font-size: 12px;">è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–tokenæ˜¯å¦æœ‰æ•ˆ</p>
                `;
            }
        }
        
        // ç²å–å–®å€‹åœè»Šå ´çš„ç•¶æœˆå¯¦éš›æ•¸æ“š
// ç²å–å–®å€‹åœè»Šå ´çš„ç•¶æœˆå¯¦éš›æ•¸æ“š - æœ€çµ‚ä¿®æ­£ç‰ˆæœ¬
async function getParkingData(lotCode) {
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    const currentDate = today.getDate();
    
    // æœ¬æœˆç¬¬ä¸€å¤©
    const firstDay = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-01`;
    const todayStr = today.toISOString().split('T')[0];
    
    try {
        const response = await fetch(
            "https://gpark.keytop.cn/nkc/parkingIncomeAndExpenditure/page",
            {
                method: "POST",
                headers: {
                    "accept": "application/json, text/plain, */*",
                    "content-type": "application/json",
                    "kt-appid": "16bbf366b49a48fab362b7f163d96c63",
                    "kt-lotcodes": lotCode,
                    "kt-token": token,
                    "client-flag": "PC"
                },
                body: JSON.stringify({
                    "lotCode": lotCode,
                    "startDate": firstDay,
                    "endDate": todayStr,
                    "byPayChannel": 0,
                    "byPayMethod": 0,
                    "byPaySource": 0,
                    "byType": 0,
                    "type": "",
                    "payMethod": "",
                    "paySource": "",
                    "payChannel": "",
                    "currentPage": 1,
                    "pageSize": 1000
                })
            }
        );
        
        const data = await response.json();
        
        if (data.resultCode === 200 && data.data && data.data.vos) {
            const records = data.data.vos;
            const lotName = lotNames[lotCode] || `åœè»Šå ´ ${lotCode}`;
            
            // é—œéµä¿®æ­£ï¼šéæ¿¾æ‰day="åˆè¨ˆ"çš„è¨˜éŒ„
            const validRecords = records.filter(record => {
                const day = record.day;
                const income = parseFloat(record.income) || 0;
                
                // åªä¿ç•™æœ‰æ•ˆçš„æ—¥æœŸè¨˜éŒ„ï¼ˆä¸æ˜¯"åˆè¨ˆ"ï¼‰
                return income > 0 && day && day !== "åˆè¨ˆ" && !day.includes("åˆè¨ˆ");
            });
            
            console.log(`ğŸ” ${lotCode} ${lotName}: åŸå§‹ ${records.length} æ¢ï¼Œæœ‰æ•ˆ ${validRecords.length} æ¢`);
            
            // è¨ˆç®—çµ±è¨ˆ
            let monthTWD = 0;
            const monthDailyStats = {};
            
            validRecords.forEach(record => {
                const income = parseFloat(record.income) || 0;
                const day = record.day;
                
                // ç´¯åŠ ç¸½æ”¶å…¥
                monthTWD += income;
                
                // è¨˜éŒ„æ¯æ—¥çµ±è¨ˆ
                if (!monthDailyStats[day]) {
                    monthDailyStats[day] = { amount: 0, count: 0 };
                }
                monthDailyStats[day].amount += income;
                monthDailyStats[day].count += 1;
            });
            
            // è¨ˆç®—ç¸½ç­†æ•¸
            const monthIncomeRecords = validRecords.length;
            
            // è¨ˆç®—æœ‰æ”¶å…¥å¤©æ•¸
            const monthDaysWithIncome = Object.keys(monthDailyStats).length;
            
            // è¨ˆç®—æ—¥å‡æ”¶å…¥
            const monthAvgPerDay = monthDaysWithIncome > 0 ? monthTWD / monthDaysWithIncome : 0;
            
            // è¨ˆç®—ç­†å‡æ”¶å…¥
            const monthAvgPerRecord = monthIncomeRecords > 0 ? monthTWD / monthIncomeRecords : 0;
            
            // èª¿è©¦è¼¸å‡º
            if (lotCode === "188600343") {
                console.log("å®¶ç¦æ•¦åŒ—è¨ˆç®—çµæœ:");
                console.log(`  ç¸½æ”¶å…¥: NT$${monthTWD}`);
                console.log(`  ç¸½ç­†æ•¸: ${monthIncomeRecords} ç­†`);
                console.log(`  æœ‰æ”¶å…¥å¤©æ•¸: ${monthDaysWithIncome} å¤©`);
                console.log("  æ¯æ—¥æ˜ç´°:");
                Object.keys(monthDailyStats).sort().forEach(day => {
                    console.log(`    ${day}: NT$${monthDailyStats[day].amount} (${monthDailyStats[day].count}ç­†)`);
                });
            }
            
            return {
                success: true,
                lotCode: lotCode,
                lotName: lotName,
                monthIncome: monthTWD,          // é€™æ‡‰è©²æ˜¯34260
                incomeRecords: monthIncomeRecords, // é€™æ‡‰è©²æ˜¯9
                daysWithIncome: monthDaysWithIncome,
                avgPerDay: monthAvgPerDay,
                avgPerRecord: monthAvgPerRecord,
                dailyStats: monthDailyStats,
                status: monthTWD > 0 ? 'active' : 'inactive'
            };
        } else {
            return {
                success: false,
                lotCode: lotCode,
                error: data.resultMsg || 'APIè¿”å›éŒ¯èª¤'
            };
        }
        
    } catch (error) {
        return {
            success: false,
            lotCode: lotCode,
            error: error.message
        };
    }
}
        // ç²å–365å¤©æ•¸æ“š
        async function get365DaysData(lotCode) {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            
            const lastYearToday = new Date(today);
            lastYearToday.setFullYear(today.getFullYear() - 1);
            const startDate = lastYearToday.toISOString().split('T')[0];
            
            try {
                const response = await fetch(
                    "https://gpark.keytop.cn/nkc/parkingIncomeAndExpenditure/page",
                    {
                        method: "POST",
                        headers: {
                            "accept": "application/json, text/plain, */*",
                            "content-type": "application/json",
                            "kt-appid": "16bbf366b49a48fab362b7f163d96c63",
                            "kt-lotcodes": lotCode,
                            "kt-token": token,
                            "client-flag": "PC"
                        },
                        body: JSON.stringify({
                            "lotCode": lotCode,
                            "startDate": startDate,
                            "endDate": endDate,
                            "byPayChannel": 0,
                            "byPayMethod": 0,
                            "byPaySource": 0,
                            "byType": 0,
                            "type": "",
                            "payMethod": "",
                            "paySource": "",
                            "payChannel": "",
                            "currentPage": 1,
                            "pageSize": 2000
                        })
                    }
                );
                
                const data = await response.json();
                
                if (data.resultCode === 200 && data.data && data.data.vos) {
                    const records = data.data.vos;
                    
                    // è¨ˆç®—365å¤©çµ±è¨ˆ
                    let totalTWD = 0;
                    let incomeRecords = 0;
                    const dailyStats = {};
                    
                    records.forEach(record => {
                        const income = parseFloat(record.income) || 0;
                        const day = record.day;
                        
                        if (income > 0) {
                            totalTWD += income;
                            incomeRecords++;
                            
                            if (day) {
                                if (!dailyStats[day]) {
                                    dailyStats[day] = { amount: 0, count: 0 };
                                }
                                dailyStats[day].amount += income;
                                dailyStats[day].count++;
                            }
                        }
                    });
                    
                    const daysWithIncome = Object.keys(dailyStats).length;
                    const avgPerDay = daysWithIncome > 0 ? totalTWD / daysWithIncome : 0;
                    const avgPerRecord = incomeRecords > 0 ? totalTWD / incomeRecords : 0;
                    
                    // æœ€è¿‘30å¤©
                    const last30Days = Object.keys(dailyStats)
                        .sort()
                        .reverse()
                        .slice(0, 30);
                    
                    let last30DaysIncome = 0;
                    let last30DaysRecords = 0;
                    last30Days.forEach(day => {
                        last30DaysIncome += dailyStats[day].amount;
                        last30DaysRecords += dailyStats[day].count;
                    });
                    
                    const last30DaysAvg = last30Days.length > 0 ? last30DaysIncome / last30Days.length : 0;
                    
                    return {
                        success: true,
                        totalTWD: totalTWD,
                        incomeRecords: incomeRecords,
                        daysWithIncome: daysWithIncome,
                        avgPerDay: avgPerDay,
                        avgPerRecord: avgPerRecord,
                        last30Days: {
                            income: last30DaysIncome,
                            days: last30Days.length,
                            avg: last30DaysAvg
                        }
                    };
                }
                
                return {
                    success: false,
                    error: data.resultMsg || 'æœªçŸ¥éŒ¯èª¤'
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // æ’åºæ•¸æ“š
        function sortData(field, direction) {
            allParkingData.sort((a, b) => {
                let aValue = a[field];
                let bValue = b[field];
                
                // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œé€²è¡Œä¸å€åˆ†å¤§å°å¯«çš„æ¯”è¼ƒ
                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aValue > bValue ? 1 : (aValue < bValue ? -1 : 0);
                } else {
                    return aValue < bValue ? 1 : (aValue > bValue ? -1 : 0);
                }
            });
        }
        
        // è¡¨æ ¼æ’åº
        function sortTable(field) {
            // å¦‚æœé»æ“ŠåŒä¸€å­—æ®µï¼Œåˆ‡æ›æ’åºæ–¹å‘
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'desc'; // é»˜èªé™åº
            }
            
            // æ¸…é™¤æ‰€æœ‰æ’åºæ¨™è¨˜
            tableHeaders.forEach(header => {
                header.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // æ·»åŠ ç•¶å‰æ’åºæ¨™è¨˜
            const currentHeader = document.querySelector(`th[data-sort="${field}"]`);
            if (currentHeader) {
                currentHeader.classList.add(`sorted-${currentSortDirection}`);
            }
            
            // é‡æ–°æ’åºæ•¸æ“š
            sortData(currentSortField, currentSortDirection);
            filteredData = [...allParkingData];
            currentPage = 1;
            renderTable();
        }
        
        // æ›´æ–°æ‘˜è¦å¡ç‰‡
        function updateSummaryCards() {
            if (allParkingData.length === 0) return;
            
            // è¨ˆç®—ç¸½æ”¶å…¥
            const totalIncome = allParkingData.reduce((sum, item) => sum + item.monthIncome, 0);
            totalMonthIncome.textContent = `NT$${formatNumber(totalIncome)}`;
            
            // æ‰¾å‡ºæœ€é«˜æ”¶å…¥å ´ç«™
            const topLot = [...allParkingData].sort((a, b) => b.monthIncome - a.monthIncome)[0];
            if (topLot) {
                topIncomeLot.textContent = topLot.lotName.substring(0, 10) + (topLot.lotName.length > 10 ? '...' : '');
            }
            
            // è¨ˆç®—å¹³å‡æ”¶å…¥
            const avg = totalIncome / allParkingData.length;
            avgIncome.textContent = `NT$${formatNumber(avg)}`;
            
            // æ›´æ–°ç¸½åœè»Šå ´æ•¸
            document.getElementById('totalParkingCount').textContent = allParkingData.length;
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            // æ›´æ–°è¨ˆæ•¸
            totalCount.textContent = allParkingData.length;
            shownCount.textContent = filteredData.length;
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableArea.style.display = 'none';
                noDataArea.style.display = 'block';
                return;
            }
            
            // è¨ˆç®—åˆ†é 
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.dataset.lotCode = item.lotCode;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                row.addEventListener('click', () => selectParkingLot(item.lotCode));
                
                // å¦‚æœæ˜¯é¸ä¸­çš„è¡Œï¼Œæ·»åŠ é«˜äº®æ¨£å¼
                if (item.lotCode === selectedLotCode) {
                    row.classList.add('selected');
                }
                
                row.innerHTML = `
                    <td><span class="status-indicator ${item.status === 'active' ? 'status-active' : 'status-inactive'}"></span></td>
                    <td>${item.lotCode}</td>
                    <td><span class="lot-name">${item.lotName}</span></td>
                    <td class="amount">NT$${formatNumber(item.monthIncome)}</td>
                    <td>${item.incomeRecords} ç­†</td>
                    <td>${item.daysWithIncome} å¤©</td>
                    <td>NT$${formatNumber(item.avgPerDay)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // æ›´æ–°åˆ†é æ§ä»¶
            updatePagination(totalPages);
            
            // æ¸²æŸ“åœ–è¡¨
            renderChart();
            
            // å¦‚æœæœ‰é¸ä¸­çš„åœè»Šå ´ï¼Œé¡¯ç¤ºå…¶è©³ç´°è³‡è¨Š
            if (selectedLotCode) {
                const selectedItem = allParkingData.find(item => item.lotCode === selectedLotCode);
                if (selectedItem) {
                    updateDetails(selectedItem);
                }
            } else if (filteredData.length > 0) {
                // é»˜èªé¸ä¸­ç¬¬ä¸€å€‹
                selectParkingLot(filteredData[0].lotCode);
            }
        }
        
        // æ›´æ–°åˆ†é æ§ä»¶
        function updatePagination(totalPages) {
            pageNumbers.innerHTML = '';
            
            // é¡¯ç¤ºæœ€å¤š5å€‹é ç¢¼æŒ‰éˆ•
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => goToPage(i));
                pageNumbers.appendChild(pageBtn);
            }
            
            // æ›´æ–°ä¸Šä¸€é /ä¸‹ä¸€é æŒ‰éˆ•ç‹€æ…‹
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // å‰å¾€æŒ‡å®šé ç¢¼
        function goToPage(page) {
            currentPage = page;
            renderTable();
        }
        
        // å‰å¾€ä¸Šä¸€é 
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }
        
        // å‰å¾€ä¸‹ä¸€é 
        function goToNextPage() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }
        
        // ç¯©é¸è¡¨æ ¼
        function filterTable() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...allParkingData];
            } else {
                filteredData = allParkingData.filter(item => 
                    item.lotCode.toLowerCase().includes(searchTerm) || 
                    item.lotName.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            renderTable();
        }
        
        // é¸æ“‡åœè»Šå ´
        async function selectParkingLot(lotCode) {
            selectedLotCode = lotCode;
            const selectedItem = allParkingData.find(item => item.lotCode === lotCode);
            
            if (selectedItem) {
                updateDetails(selectedItem);
                
                // æ›´æ–°è¡¨æ ¼ä¸­çš„é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('#tableBody tr').forEach(row => {
                    if (row.dataset.lotCode === lotCode) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
                
                // ç²å–365å¤©æ¯”è¼ƒæ•¸æ“š
                comparisonData = await get365DaysData(lotCode);
                if (comparisonContainer.style.display !== 'none') {
                    renderComparison();
                }
            }
        }
        
        // æ›´æ–°è©³ç´°è³‡è¨Š
// æ›´æ–°è©³ç´°è³‡è¨Š - ä¿®æ­£ç‰ˆæœ¬ï¼ˆé¿å…åˆè¨ˆé‡è¤‡ï¼‰
function updateDetails(item) {
    detailLotCode.textContent = item.lotCode;
    detailLotName.textContent = item.lotName;
    detailMonthIncome.textContent = `NT$${formatNumber(item.monthIncome)}`;
    detailIncomeRecords.textContent = `${item.incomeRecords} ç­†`;
    detailDaysWithIncome.textContent = `${item.daysWithIncome} å¤©`;
    detailAvgPerDay.textContent = `NT$${formatNumber(item.avgPerDay)}`;
    detailAvgPerRecord.textContent = `NT$${formatNumber(item.avgPerRecord)}`;
    
    // é¡¯ç¤ºæ¯æ—¥æ˜ç´°
    if (item.dailyStats && Object.keys(item.dailyStats).length > 0) {
        dailyDetails.style.display = 'block';
        
        // å…ˆæ¸…ç©ºèˆŠå…§å®¹
        dailyDetailsContent.innerHTML = '';
        
        // æŒ‰æ—¥æœŸæ’åº
        const sortedDays = Object.keys(item.dailyStats).sort();
        
        // é‡æ–°è¨ˆç®—ç¸½å’Œï¼ˆé¿å…ä½¿ç”¨ç·©å­˜çš„éŒ¯èª¤å€¼ï¼‰
        let totalAmount = 0;
        let totalRecords = 0;
        
        // æ·»åŠ æ¯æ—¥æ˜ç´°
        sortedDays.forEach(day => {
            const dayStats = item.dailyStats[day];
            totalAmount += dayStats.amount;
            totalRecords += dayStats.count;
            
            const dailyItem = document.createElement('div');
            dailyItem.className = 'daily-item';
            dailyItem.innerHTML = `
                <span class="daily-date">${day}</span>
                <span class="daily-amount">NT$${formatNumber(dayStats.amount)} (${dayStats.count}ç­†)</span>
            `;
            dailyDetailsContent.appendChild(dailyItem);
        });
        
        // åªæ·»åŠ ä¸€æ¬¡åˆè¨ˆè¡Œ
        const totalItem = document.createElement('div');
        totalItem.className = 'daily-item daily-total';
        totalItem.innerHTML = `
            <span class="daily-date">åˆè¨ˆ</span>
            <span class="daily-amount">NT$${formatNumber(totalAmount)} (${totalRecords}ç­†)</span>
        `;
        dailyDetailsContent.appendChild(totalItem);
        
    } else {
        dailyDetails.style.display = 'none';
    }
} 
        // æ¸²æŸ“æ”¶å…¥åˆ†ä½ˆåœ–
        function renderChart() {
            // å–å‰10åæ”¶å…¥æœ€é«˜çš„åœè»Šå ´
            const top10 = [...filteredData]
                .sort((a, b) => b.monthIncome - a.monthIncome)
                .slice(0, 10);
            
            if (top10.length === 0) {
                incomeChart.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 80px;">ç„¡æ•¸æ“šå¯é¡¯ç¤º</p>';
                return;
            }
            
            // æ‰¾å‡ºæœ€é«˜æ”¶å…¥ç”¨æ–¼è¨ˆç®—æ¯”ä¾‹
            const maxIncome = Math.max(...top10.map(item => item.monthIncome));
            
            incomeChart.innerHTML = '';
            
            top10.forEach(item => {
                const barHeight = maxIncome > 0 ? (item.monthIncome / maxIncome) * 100 : 0;
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}%`;
                bar.title = `${item.lotName}: NT$${formatNumber(item.monthIncome)}`;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                bar.addEventListener('click', () => selectParkingLot(item.lotCode));
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = item.lotCode.substring(8); // é¡¯ç¤ºå¾Œ3ä½
                
                bar.appendChild(label);
                incomeChart.appendChild(bar);
            });
        }
        
        // æ¸²æŸ“æ¯”è¼ƒåˆ†æ
        function renderComparison() {
            if (!comparisonData || !comparisonData.success || !selectedLotCode) {
                comparisonContent.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">è«‹å…ˆé¸æ“‡ä¸€å€‹åœè»Šå ´</p>';
                return;
            }
            
            const selectedItem = allParkingData.find(item => item.lotCode === selectedLotCode);
            if (!selectedItem) return;
            
            const monthData = selectedItem;
            const yearData = comparisonData;
            
            // è¨ˆç®—æ¯”è¼ƒåˆ†æ
            const dailyComparison = yearData.avgPerDay > 0 ? 
                ((monthData.avgPerDay - yearData.avgPerDay) / yearData.avgPerDay * 100).toFixed(1) : 0;
            
            const last30Comparison = yearData.last30Days.avg > 0 ? 
                ((monthData.avgPerDay - yearData.last30Days.avg) / yearData.last30Days.avg * 100).toFixed(1) : 0;
            
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const monthlyTarget = yearData.avgPerDay * daysInMonth;
            const targetCompletion = monthlyTarget > 0 ? (monthData.monthIncome / monthlyTarget * 100).toFixed(1) : 0;
            
            let neededDaily = 0;
            if (monthData.monthIncome < monthlyTarget) {
                neededDaily = (monthlyTarget - monthData.monthIncome) / (daysInMonth - today.getDate());
            }
            
            comparisonContent.innerHTML = '';
            
            // å‰µå»ºæ¯”è¼ƒé …ç›®
            const comparisonItems = [
                {
                    label: 'ç•¶æœˆæ—¥å‡ vs å…¨å¹´æ—¥å‡',
                    value: `${dailyComparison >= 0 ? '+' : ''}${dailyComparison}%`,
                    subvalue: `(${formatNumber(monthData.avgPerDay)} vs ${formatNumber(yearData.avgPerDay)})`,
                    className: dailyComparison >= 0 ? 'positive' : 'negative'
                },
                {
                    label: 'ç•¶æœˆæ—¥å‡ vs æœ€è¿‘30å¤©æ—¥å‡',
                    value: `${last30Comparison >= 0 ? '+' : ''}${last30Comparison}%`,
                    subvalue: `(${formatNumber(monthData.avgPerDay)} vs ${formatNumber(yearData.last30Days.avg)})`,
                    className: last30Comparison >= 0 ? 'positive' : 'negative'
                },
                {
                    label: 'åŸºæ–¼å…¨å¹´æ—¥å‡çš„æœˆåº¦ç›®æ¨™',
                    value: `NT$${formatNumber(monthlyTarget)}`,
                    subvalue: `(${formatNumber(yearData.avgPerDay)} Ã— ${daysInMonth}å¤©)`
                },
                {
                    label: 'æœˆåº¦ç›®æ¨™é”æˆç‡',
                    value: `${targetCompletion}%`,
                    subvalue: `(${formatNumber(monthData.monthIncome)} / ${formatNumber(monthlyTarget)})`,
                    className: parseFloat(targetCompletion) >= 100 ? 'positive' : 'negative'
                }
            ];
            
            if (neededDaily > 0) {
                comparisonItems.push({
                    label: 'å‰©é¤˜å¤©æ•¸éœ€æ—¥å‡',
                    value: `NT$${formatNumber(neededDaily)}`,
                    subvalue: `æ‰èƒ½é”æˆæœˆåº¦ç›®æ¨™`
                });
            }
            
            // æ·»åŠ æ¯”è¼ƒé …ç›®åˆ°DOM
            comparisonItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'comparison-item';
                div.innerHTML = `
                    <div class="comparison-label">${item.label}</div>
                    <div class="comparison-value ${item.className || ''}">${item.value}</div>
                    <div class="comparison-subvalue">${item.subvalue}</div>
                `;
                comparisonContent.appendChild(div);
            });
            
            // æ·»åŠ 365å¤©çµ±è¨ˆæ‘˜è¦
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'comparison-item';
            summaryDiv.innerHTML = `
                <div class="comparison-label" style="font-weight: bold; color: #1a6dcc;">365å¤©çµ±è¨ˆæ‘˜è¦</div>
                <div class="comparison-subvalue">ç¸½æ”¶å…¥: NT$${formatNumber(yearData.totalTWD)}</div>
                <div class="comparison-subvalue">æœ‰æ”¶å…¥å¤©æ•¸: ${yearData.daysWithIncome} å¤© / 365å¤©</div>
                <div class="comparison-subvalue">æ—¥å‡æ”¶å…¥: NT$${formatNumber(yearData.avgPerDay)}</div>
                <div class="comparison-subvalue">æœ€è¿‘30å¤©æ—¥å‡: NT$${formatNumber(yearData.last30Days.avg)}</div>
            `;
            comparisonContent.appendChild(summaryDiv);
        }
        
        // åˆ‡æ›æ¯”è¼ƒåˆ†æé¡¯ç¤º
        function toggleComparison() {
            if (comparisonContainer.style.display === 'none') {
                comparisonContainer.style.display = 'block';
                if (selectedLotCode && comparisonData) {
                    renderComparison();
                } else {
                    comparisonContent.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">è«‹å…ˆé¸æ“‡ä¸€å€‹åœè»Šå ´</p>';
                }
                comparisonBtn.innerHTML = '<i class="fas fa-eye-slash"></i> éš±è—æ¯”è¼ƒåˆ†æ';
            } else {
                comparisonContainer.style.display = 'none';
                comparisonBtn.innerHTML = '<i class="fas fa-chart-bar"></i> é¡¯ç¤ºæ¯”è¼ƒåˆ†æ';
            }
        }
        
        // åŒ¯å‡ºå ±è¡¨
        function exportReport() {
            if (allParkingData.length === 0) {
                alert('æš«ç„¡æ•¸æ“šå¯åŒ¯å‡º');
                return;
            }
            
            // å‰µå»ºCSVå…§å®¹
            let csvContent = "å ´ç«™ç·¨è™Ÿ,å ´ç«™åç¨±,æœ¬æœˆç´¯è¨ˆæ”¶å…¥,æ”¶å…¥ç­†æ•¸,æœ‰æ”¶å…¥å¤©æ•¸,æ—¥å‡æ”¶å…¥\n";
            
            allParkingData.forEach(item => {
                csvContent += `${item.lotCode},"${item.lotName}",${item.monthIncome},${item.incomeRecords},${item.daysWithIncome},${item.avgPerDay}\n`;
            });
            
            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `åœè»Šå ´æ”¶å…¥å ±è¡¨_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`å·²åŒ¯å‡º ${allParkingData.length} å€‹åœè»Šå ´çš„æ•¸æ“š`);
        }
        
        // æ ¼å¼åŒ–æ•¸å­—ï¼ˆåƒåˆ†ä½ï¼‰
        function formatNumber(num) {
            return Math.round(num).toLocaleString('zh-TW');
        }
    </script>
</body>
</html>